<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroLink Web Serial Terminal</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- ä»£ç é¢„è§ˆåŒºç¾åŒ–å’Œå¤åˆ¶æŒ‰é’® -->
    <style>
.code-block { background: #1e1e1e; color: #f8f8f2; font-family: 'Consolas', 'Menlo', 'Monaco', 'monospace'; font-size: 14px; line-height: 1.6; border-radius: 8px; padding: 18px 18px 18px 24px; overflow-x: auto; min-height: 120px; white-space: pre; position: relative; }
.code-copy-btn { position: absolute; top: 12px; right: 18px; background: #444; color: #fff; border: none; border-radius: 4px; padding: 4px 12px; font-size: 13px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; z-index: 2; }
.code-copy-btn:hover { opacity: 1; background: #3498db; }
/* å³ä¾§é¢æ¿æ•´ä½“ç¾åŒ– */
.right-panel {
    background: #f7fafd;
    border-radius: 14px;
    box-shadow: 0 4px 24px rgba(52,152,219,0.08);
    padding: 28px 24px 24px 24px;
    margin: 0 0 0 18px;
    min-width: 420px;
}

/* FLM ELFè§£æå™¨ç¾åŒ– */
.flm-parser-panel {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(52,152,219,0.07);
    padding: 28px 28px 18px 28px;
    margin-bottom: 18px;
    border: 1.5px solid #e3eaf2;
}
.flm-parser-panel h2 {
    color: #2980b9;
    font-size: 1.6rem;
    margin-bottom: 8px;
}
.flm-parser-panel p {
    color: #666;
    font-size: 1.05rem;
    margin-bottom: 18px;
}
.flm-parser-panel input[type="file"] {
    margin: 10px 0 18px 0;
    font-size: 1rem;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    padding: 8px 12px;
    background: #f8fafc;
}
.flm-parser-panel button, .flm-parser-panel a.btn {
    margin: 8px 8px 8px 0;
    width: 160px;
    font-size: 1rem;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(52,152,219,0.06);
    text-align: center;
    padding: 10px 16px;
}
.flm-parser-panel a.btn {
    padding: 10px 16px;
    display: inline-block;
    text-decoration: none;
}
.flm-parser-panel pre#log {
    background: #23272e;
    color: #e0e0e0;
    border-radius: 7px;
    padding: 14px 18px;
    font-size: 14px;
    min-height: 80px;
    margin-top: 12px;
    margin-bottom: 0;
    font-family: 'Consolas', 'Menlo', 'Monaco', 'monospace';
    box-shadow: 0 1px 4px rgba(52,152,219,0.04);
}

#flmYmodemSendBtn {
    width: 160px;
    font-size: 1rem;
    border-radius: 6px;
}
#flmYmodemProgress {
    width: 180px;
    height: 16px;
    vertical-align: middle;
    margin-left: 16px;
    border-radius: 8px;
    background: #eaf6fb;
    box-shadow: 0 1px 4px rgba(52,152,219,0.04);
}
#flmYmodemLog {
    background: #23272e;
    color: #0f0;
    padding: 8px 10px;
    border-radius: 6px;
    min-height: 36px;
    max-height: 90px;
    overflow: auto;
    font-size: 13px;
    margin-top: 8px;
    font-family: 'Consolas', 'Menlo', 'Monaco', 'monospace';
}

/* Pythonè„šæœ¬ç”Ÿæˆå™¨ç¾åŒ– */
.config-panel {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(52,152,219,0.07);
    padding: 24px 24px 18px 24px;
    border: 1.5px solid #e3eaf2;
}
.config-group {
    margin-bottom: 22px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9e9e9;
}
.config-group:last-child {
    border-bottom: none;
}
.config-panel h2 {
    color: #2980b9;
    font-size: 1.18rem;
    margin-bottom: 8px;
}
.config-panel label {
    font-weight: 500;
    color: #444;
    margin-bottom: 4px;
}
.config-panel input, .config-panel select {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #d0d7de;
    border-radius: 6px;
    font-size: 1rem;
    margin-bottom: 8px;
    background: #f8fafc;
    transition: border-color 0.2s;
}
.config-panel input:focus, .config-panel select:focus {
    border-color: #3498db;
    outline: none;
}
.btn-download {
    width: 100%;
    margin-top: 18px;
    font-size: 1.08rem;
    border-radius: 6px;
    padding: 12px 0;
    box-shadow: 0 2px 8px rgba(52,152,219,0.06);
}
.preview-panel {
    background: #23272e;
    border-radius: 12px;
    padding: 24px 18px 18px 18px;
    color: #f8f8f2;
    box-shadow: 0 2px 12px rgba(52,152,219,0.07);
    min-width: 320px;
    margin-left: 18px;
}
.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.code-header h2 {
    color: #fff;
    font-size: 1.18rem;
    margin: 0;
}
.script-tabs {
    display: flex;
    gap: 10px;
}
.script-tab {
    padding: 7px 18px;
    background: #444;
    color: #ccc;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}
.script-tab.active {
    background: #3498db;
    color: #fff;
}
.script-tab:hover {
    background: #555;
}
.script-tab.active:hover {
    background: #2980b9;
}
.script-content {
    display: none;
}
.script-content.active {
    display: block;
}
.code-block {
    background: #181c23;
    color: #f8f8f2;
    font-family: 'Consolas', 'Menlo', 'Monaco', 'monospace';
    font-size: 15px;
    line-height: 1.7;
    border-radius: 8px;
    padding: 18px 18px 18px 24px;
    overflow-x: auto;
    min-height: 120px;
    white-space: pre;
    position: relative;
    box-shadow: 0 1px 4px rgba(52,152,219,0.04);
}
.code-copy-btn {
    position: absolute;
    top: 12px;
    right: 18px;
    background: #3498db;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 4px 12px;
    font-size: 13px;
    cursor: pointer;
    opacity: 0.85;
    transition: opacity 0.2s, background 0.2s;
    z-index: 2;
}
.code-copy-btn:hover {
    opacity: 1;
    background: #217dbb;
}
.highlight {
    background-color: #ffe082;
    color: #222;
    border-radius: 3px;
    padding: 1px 4px;
}
@media (max-width: 1200px) {
    .right-panel { min-width: 320px; padding: 18px 6px 18px 6px; }
    .preview-panel { min-width: 0; margin-left: 0; }
}
@media (max-width: 900px) {
    .right-panel { min-width: 0; padding: 8px 2px 8px 2px; }
    .preview-panel { padding: 12px 4px 12px 4px; }
}
    </style>
    <style>
#pyYmodemLog, #flmYmodemLog, #log, #pyYmodemProgress { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨æ§åˆ¶æ  -->
        <header class="header">
            <div class="header-left">
                <h1><i class="fas fa-microchip"></i> MicroLink Web Serial Terminal</h1>
            </div>
            <div class="header-right">
                <!-- ç§»åŠ¨è¿‡æ¥çš„å››ä¸ªæŒ‰é”® -->
                <div class="header-controls">
                    <button id="connectBtn" class="btn btn-primary"><i class="fas fa-plug"></i> è¿æ¥ä¸²å£</button>
                    <button id="disconnectBtn" class="btn btn-secondary" disabled><i class="fas fa-times"></i> æ–­å¼€è¿æ¥</button>
                    <button id="clearBtn" class="btn btn-warning"><i class="fas fa-trash"></i> æ¸…ç©º</button>
                    <button id="saveLogBtn" class="btn btn-info"><i class="fas fa-save"></i> ä¿å­˜æ—¥å¿—</button>
                </div>
                <div class="connection-status">
                    <span id="connectionStatus" class="status-disconnected">
                        <i class="fas fa-circle"></i> æœªè¿æ¥
                    </span>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- å·¦ä¾§åŠŸèƒ½å—é€‰æ‹©æ  -->
            <div class="sidebar">
                <button class="sidebar-btn active" data-panel="serialPanel">ä¸²å£è°ƒè¯•</button>
                <button class="sidebar-btn" data-panel="flmPanel">FLMé…ç½®</button>
                <button class="sidebar-btn" data-panel="scriptPanel">Pythonè„šæœ¬é…ç½®</button>
                <button class="sidebar-btn" data-panel="varPanel">å˜é‡åˆ†æ</button>
            </div>
            <!-- ä¸­é—´åŠŸèƒ½å†…å®¹åŒº -->
            <div class="center-panel">
                <!-- ä¸²å£è°ƒè¯•å†…å®¹ï¼ˆAPIæ§åˆ¶åŒºï¼Œé»˜è®¤æ˜¾ç¤ºï¼‰ -->
                <div id="serialPanel" class="center-content" style="display: block;">
                    <div class="control-panel">
                        <h3><i class="fas fa-cogs"></i> MicroLink API æ§åˆ¶</h3>
                        <!-- å‚æ•°ç®¡ç† -->
                        <div class="api-section">
                            <h4><i class="fas fa-save"></i> å‚æ•°ç®¡ç†</h4>
                            <div class="button-group">
                                <button id="saveParams" class="btn btn-success">ä¿å­˜åˆ°æœ¬åœ°</button>
                                <button id="saveToFile" class="btn btn-primary">ä¿å­˜åˆ°æ–‡ä»¶</button>
                                <button id="loadParams" class="btn btn-info">åŠ è½½å‚æ•°</button>
                                <button id="resetParams" class="btn btn-warning">é‡ç½®å‚æ•°</button>
                                <button id="loadConfigFile" class="btn btn-secondary">é‡æ–°åŠ è½½HTMLé…ç½®</button>
                            </div>
                            <div class="param-group">
                                <label>æ‰‹åŠ¨é€‰æ‹©é…ç½®æ–‡ä»¶ (å¯é€‰):</label>
                                <input type="file" id="configFileInput" accept=".txt" class="param-input" style="font-size: 12px;">
                            </div>
                        </div>
                        <!-- è‡ªå®šä¹‰å‘½ä»¤ -->
                        <div class="api-section">
                            <h4><i class="fas fa-terminal"></i> è‡ªå®šä¹‰å‘½ä»¤</h4>
                            <div class="param-group">
                                <textarea id="customCommand" placeholder="è¾“å…¥è‡ªå®šä¹‰å‘½ä»¤..." class="custom-command-input"></textarea>
                            </div>
                            <div class="button-group">
                                <button id="sendCustom" class="btn btn-primary">å‘é€å‘½ä»¤</button>
                                <button id="addCustom" class="btn btn-secondary">æ·»åŠ åˆ°åˆ—è¡¨</button>
                            </div>
                            <div id="customCommandsList" class="custom-commands-list"></div>
                        </div>
                        <!-- RTTæ§åˆ¶ -->
                        <div class="api-section">
                            <h4><i class="fas fa-satellite-dish"></i> RTT æ§åˆ¶</h4>
                            <div class="param-group">
                                <label>RTTåœ°å€:</label>
                                <input type="text" id="rttAddr" value="0x20000000" class="param-input">
                            </div>
                            <div class="param-group">
                                <label>æœç´¢å¤§å°:</label>
                                <input type="text" id="rttSize" value="0x4000" class="param-input">
                            </div>
                            <div class="param-group">
                                <label>é€šé“:</label>
                                <input type="number" id="rttChannel" value="0" class="param-input">
                            </div>
                            <div class="button-group">
                                <button id="startRTT" class="btn btn-primary">å¯åŠ¨RTT</button>
                                <button id="stopRTT" class="btn btn-secondary">åœæ­¢RTT</button>
                            </div>
                        </div>
                        <!-- SystemViewæ§åˆ¶ -->
                        <div class="api-section">
                            <h4><i class="fas fa-chart-line"></i> SystemView æ§åˆ¶</h4>
                            <div class="param-group">
                                <label>RTTåœ°å€:</label>
                                <input type="text" id="svAddr" value="0x20000000" class="param-input">
                            </div>
                            <div class="param-group">
                                <label>æœç´¢å¤§å°:</label>
                                <input type="text" id="svSize" value="0x4000" class="param-input">
                            </div>
                            <div class="param-group">
                                <label>é€šé“:</label>
                                <input type="number" id="svChannel" value="1" class="param-input">
                            </div>
                            <div class="button-group">
                                <button id="startSystemView" class="btn btn-primary">å¯åŠ¨SystemView</button>
                            </div>
                        </div>
                        <!-- FLMä¸‹è½½ç®—æ³• -->
                        <div class="api-section">
                            <h4><i class="fas fa-download"></i> FLM ä¸‹è½½ç®—æ³•</h4>
                            <div class="param-group">
                                <label>FLMè·¯å¾„:</label>
                                <input type="text" id="flmPath" value="STM32/STM32F4xx_1024.FLM.o" class="param-input">
                            </div>
                            <div class="param-group">
                                <label>FlashåŸºåœ°å€:</label>
                                <input type="text" id="baseAddr" value="0x08000000" class="param-input">
                            </div>
                            <div class="param-group">
                                <label>RAMåœ°å€:</label>
                                <input type="text" id="ramAddr" value="0x20000000" class="param-input">
                            </div>
                            <div class="button-group">
                                <button id="loadFLM" class="btn btn-primary">åŠ è½½FLM</button>
                            </div>
                        </div>
                        <!-- å›ºä»¶ä¸‹è½½ -->
                        <div class="api-section">
                            <h4><i class="fas fa-upload"></i> å›ºä»¶ä¸‹è½½</h4>
                            <div class="param-group">
                                <label>BINæ–‡ä»¶è·¯å¾„:</label>
                                <input type="text" id="binPath" value="firmware.bin" class="param-input">
                            </div>
                            <div class="param-group">
                                <label>ä¸‹è½½åœ°å€:</label>
                                <input type="text" id="binAddr" value="0x08000000" class="param-input">
                            </div>
                            <div class="button-group">
                                <button id="loadBin" class="btn btn-primary">ä¸‹è½½å›ºä»¶</button>
                                <button id="offlineDownload" class="btn btn-warning">è„±æœºä¸‹è½½</button>
                            </div>
                        </div>
                        <!-- Ymodemä¼ è¾“ -->
                        <div class="api-section">
                            <h4><i class="fas fa-exchange-alt"></i> Ymodem ä¼ è¾“</h4>
                            <div class="param-group">
                                <label>æ–‡ä»¶è·¯å¾„:</label>
                                <input type="text" id="ymodemFile" value="update.bin" class="param-input">
                            </div>
                            <div class="button-group">
                                <button id="ymodemSend" class="btn btn-primary">å‘é€æ–‡ä»¶</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- FLMé…ç½®å†…å®¹ -->
                <div id="flmPanel" class="center-content" style="display: none;">
                    <div class="flm-parser-panel">
                        <h2>FLM ELFè§£æå™¨</h2>
                        <p>å°†FLM ELFæ–‡ä»¶è½¬æ¢ä¸º.oæ ¼å¼ï¼Œç”¨äºä¸²å£è®¾å¤‡çƒ§å†™</p>
                        <input type="file" id="flmFile" accept=".FLM">
                        <button id="convertBtn" disabled class="btn btn-warning">è½¬æ¢ä¸º .o æ–‡ä»¶</button>
                        <a id="downloadLink" href="#" style="display: none;" class="btn btn-success">ä¸‹è½½ .o æ–‡ä»¶</a>
                        <pre id="log"></pre>
                        <!-- YMODEMå‘é€åŒº -->
                        <button id="flmYmodemSendBtn" class="btn btn-primary" disabled>å‘é€FLMæ–‡ä»¶</button>
                        <progress id="flmYmodemProgress" value="0" max="100" style="width:180px;vertical-align:middle;display:none;margin:8px 0 0 0;"></progress>
                    </div>
                </div>
                <!-- Pythonè„šæœ¬é…ç½®å†…å®¹ -->
                <div id="scriptPanel" class="center-content" style="display: none;">
                    <div class="content">
                        <div class="config-panel">
                            <div class="config-group">
                                <h2>æ‹–æ‹½ä¸‹è½½FLMæ–‡ä»¶é…ç½®</h2>
                                <div class="form-group">
                                    <label for="customFlm">FLMæ–‡ä»¶å:</label>
                                    <input type="text" id="customFlm" placeholder="ä¾‹å¦‚: custom_flm.FLM.o">
                                </div>
                            </div>
                            <div class="config-group">
                                <h2>å†…å­˜åœ°å€é…ç½®</h2>
                                <div class="address-inputs">
                                    <div class="form-group">
                                        <label for="address1">FLASHåŸºåœ°å€ (åå…­è¿›åˆ¶):</label>
                                        <input type="text" id="address1" value="0X08000000" placeholder="ä¾‹å¦‚: 0X08000000">
                                    </div>
                                    <div class="form-group">
                                        <label for="address2">RAMåŸºåœ°å€ (åå…­è¿›åˆ¶):</label>
                                        <input type="text" id="address2" value="0x20000000" placeholder="ä¾‹å¦‚: 0x20000000">
                                    </div>
                                </div>
                            </div>
                            <div class="config-group">
                                <h2>å¤šæ–‡ä»¶ç¦»çº¿çƒ§å½•é…ç½®</h2>
                                <div class="multi-file-config">
                                    <div class="file-table-header">
                                        <span class="file-name-col">æ–‡ä»¶å</span>
                                        <span class="file-address-col">åœ°å€</span>
                                        <span class="file-algorithm-col">ä¸‹è½½ç®—æ³•</span>
                                        <span class="file-action-col">æ“ä½œ</span>
                                    </div>
                                    <div id="fileTableBody" class="file-table-body">
                                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶è¡Œå°†åœ¨è¿™é‡Œ -->
                                    </div>
                                    <div class="file-table-actions">
                                        <button type="button" id="addFileBtn" class="btn btn-success">
                                            <i class="fas fa-plus"></i> æ·»åŠ æ–‡ä»¶
                                        </button>
                                        <button type="button" id="clearFilesBtn" class="btn btn-warning">
                                            <i class="fas fa-trash"></i> æ¸…ç©ºæ‰€æœ‰
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="config-group">
                                <h2>SWDä¸‹è½½é€Ÿåº¦é…ç½®</h2>
                                <div class="form-group">
                                    <label for="swdClockSpeed">SWDæ—¶é’Ÿé€Ÿåº¦:</label>
                                    <select id="swdClockSpeed">
                                        <option value="10M">10M (æœ€å¿«)</option>
                                        <option value="5M">5M</option>
                                        <option value="2M">2M</option>
                                        <option value="1M">1M</option>
                                        <option value="500K">500K</option>
                                        <option value="200K">200K</option>
                                        <option value="100K">100K</option>
                                        <option value="50K">50K</option>
                                        <option value="20K">20K</option>
                                        <option value="10K">10K</option>
                                        <option value="5K">5K</option>
                                    </select>
                                </div>
                            </div>
                            <div class="config-group">
                                <button class="download-btn send-offline" id="pyYmodemSendOfflineBtn">å‘é€ç¦»çº¿ä¸‹è½½pythonæ–‡ä»¶</button>
                                <button class="download-btn send-drag" id="pyYmodemSendDragBtn">å‘é€æ‹–æ‹½ä¸‹è½½pythonæ–‡ä»¶</button>
                                <progress id="pyYmodemProgress" value="0" max="100" style="width:180px;vertical-align:middle;display:none;margin-left:16px;"></progress>
                                <pre id="pyYmodemLog" style="background:#23272e;color:#0f0;padding:8px 10px;border-radius:6px;min-height:36px;max-height:90px;overflow:auto;font-size:13px;margin-top:8px;font-family:'Consolas','Menlo','Monaco','monospace';"></pre>
                            </div>
                        </div>
                        <!--
                        <div class="preview-panel">
                            <div class="code-header">
                                <h2>ç”Ÿæˆçš„Pythonä»£ç </h2>
                                <div class="script-tabs">
                                    <button class="script-tab active" onclick="switchScriptTab('offline')">ç¦»çº¿ä¸‹è½½è„šæœ¬</button>
                                    <button class="script-tab" onclick="switchScriptTab('drag')">æ‹–æ‹½ä¸‹è½½è„šæœ¬</button>
                                </div>
                            </div>
                            <div id="offlineScript" class="script-content active">
                                <div style="position:relative;">
                                    <button class="code-copy-btn" id="copyOfflineBtn">å¤åˆ¶</button>
                                    <pre class="code-block"><code id="codePreview"></code></pre>
                                </div>
                            </div>
                            <div id="dragScript" class="script-content">
                                <div style="position:relative;">
                                    <button class="code-copy-btn" id="copyDragBtn">å¤åˆ¶</button>
                                    <pre class="code-block"><code id="dragCodePreview"></code></pre>
                                </div>
                            </div>
                        </div>
                    -->
                        
                    </div>
                </div>
                <!-- å˜é‡åˆ†æå†…å®¹ -->
                <div id="varPanel" class="center-content" style="display: none;">
                    <style>
                        /* å˜é‡åˆ†ætabç¾åŒ–ï¼Œç»Ÿä¸€ä¸»ç«™é£æ ¼ */
                        #varPanel .container {
                            background: #fff;
                            border-radius: 12px;
                            box-shadow: 0 2px 12px rgba(52,152,219,0.07);
                            padding: 24px 24px 18px 24px;
                            border: 1.5px solid #e3eaf2;
                            margin-top: 18px;
                            width: 100%;
                            max-width: none;
                        }
                        #varPanel .header {
                            background: linear-gradient(135deg, #3498db, #764ba2);
                            color: #fff;
                            padding: 18px 20px;
                            border-radius: 10px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 8px rgba(52,152,219,0.08);
                        }
                        #varPanel .card {
                            border-radius: 10px;
                            box-shadow: 0 2px 8px rgba(52,152,219,0.06);
                            margin-bottom: 20px;
                            border: none;
                        }
                        #varPanel .card-header {
                            background-color: #f0f3fa;
                            border-bottom: 1px solid #e3eaf2;
                            font-weight: 600;
                            padding: 13px 18px;
                            border-radius: 10px 10px 0 0 !important;
                            color: #2980b9;
                        }
                        #varPanel .table-container {
                            max-height: 400px;
                            overflow-y: auto;
                        }
                        #varPanel .variable-table {
                            width: 100%;
                            font-size: 14px;
                        }
                        #varPanel .variable-table th {
                            background-color: #eaf6fb;
                            position: sticky;
                            top: 0;
                            z-index: 10;
                        }
                        #varPanel .memory-map {
                            height: 300px;
                            background-color: #f8fafc;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                            position: relative;
                        }
                        #varPanel .legend {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 10px;
                            margin-top: 15px;
                        }
                        #varPanel .legend-item {
                            display: flex;
                            align-items: center;
                            font-size: 13px;
                        }
                        #varPanel .legend-color {
                            width: 15px;
                            height: 15px;
                            border-radius: 3px;
                            margin-right: 5px;
                            border: 1px solid rgba(0,0,0,0.1);
                        }
                        #varPanel .status-bar {
                            background-color: #eaf6fb;
                            padding: 10px 15px;
                            border-radius: 5px;
                            margin-top: 20px;
                            color: #2980b9;
                        }
                        #varPanel .detail-card {
                            background-color: #f8f9fa;
                            border-radius: 8px;
                            padding: 15px;
                            font-size: 14px;
                            font-family: monospace;
                            white-space: pre-wrap;
                            max-height: 200px;
                            overflow-y: auto;
                        }
                        #varPanel .file-info {
                            background-color: #e7f4e4;
                            padding: 10px;
                            border-radius: 5px;
                            margin-bottom: 15px;
                            font-size: 13px;
                        }
                        #varPanel .btn-primary {
                            background: #3498db;
                            color: #fff;
                            border: none;
                            border-radius: 6px;
                            font-weight: 600;
                            font-size: 15px;
                            padding: 8px 0;
                            transition: background 0.2s;
                        }
                        #varPanel .btn-primary:disabled {
                            background: #b3d3f7;
                            color: #fff;
                        }
                        #varPanel .btn-primary:hover:not(:disabled) {
                            background: #2980b9;
                        }
                        #varPanel .form-label {
                            font-weight: 500;
                            color: #2980b9;
                        }
                        #varPanel .progress-bar {
                            background: linear-gradient(90deg, #3498db, #764ba2);
                        }
                        /* å˜é‡åˆ†æé¡µé¢æ–°å¸ƒå±€æ ·å¼ */
                        #varPanel .var-analysis-layout {
                            display: grid;
                            grid-template-columns: 1fr 1.5fr;
                            gap: 25px;
                            height: calc(100vh - 180px);
                            width: 100%;
                            max-width: none;
                            margin: 0;
                            padding: 0;
                        }
                        #varPanel .left-panel {
                            display: flex;
                            flex-direction: column;
                            gap: 20px;
                            min-width: 320px;
                            flex: 1;
                        }
                        #varPanel .right-panel {
                            display: flex;
                            flex-direction: column;
                            gap: 20px;
                            min-width: 400px;
                            flex: 1.5;
                            align-items: stretch;
                        }
                        #varPanel .filter-section {
                            background: #fff;
                            border-radius: 12px;
                            padding: 20px;
                            box-shadow: 0 2px 8px rgba(52,152,219,0.06);
                            border: 1.5px solid #e3eaf2;
                        }
                        #varPanel .filter-controls {
                            display: flex;
                            gap: 15px;
                            align-items: center;
                            margin-bottom: 15px;
                            flex-wrap: wrap;
                        }
                        #varPanel .filter-controls select {
                            padding: 8px 12px;
                            border: 1px solid #d0d7de;
                            border-radius: 6px;
                            font-size: 14px;
                            background: #f8fafc;
                        }
                        #varPanel .filter-controls input {
                            padding: 8px 12px;
                            border: 1px solid #d0d7de;
                            border-radius: 6px;
                            font-size: 14px;
                            background: #f8fafc;
                            width: 100%;
                            min-width: 150px;
                        }
                        #varPanel .variable-table-container {
                            background: #fff;
                            border-radius: 12px;
                            padding: 20px;
                            box-shadow: 0 2px 8px rgba(52,152,219,0.06);
                            border: 1.5px solid #e3eaf2;
                            flex: 1;
                            overflow: hidden;
                            min-height: 350px;
                            min-width: 0;
                        }
                        #varPanel .variable-table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        #varPanel .variable-table th,
                        #varPanel .variable-table td {
                            padding: 10px 12px;
                            text-align: left;
                            border-bottom: 1px solid #e3eaf2;
                        }
                        #varPanel .variable-table th:first-child,
                        #varPanel .variable-table td:first-child {
                            width: 60px;
                            text-align: center;
                        }
                        #varPanel .variable-table th:nth-child(2),
                        #varPanel .variable-table td:nth-child(2) {
                            white-space: normal;
                            word-break: break-word;
                            max-width: 0;
                        }
                        #varPanel .variable-table th:nth-child(3),
                        #varPanel .variable-table td:nth-child(3) {
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                        #varPanel .variable-table th:nth-child(4),
                        #varPanel .variable-table td:nth-child(4) {
                            white-space: nowrap;
                            text-align: right;
                        }
                        #varPanel .variable-table th {
                            background: linear-gradient(135deg, #eaf6fb 0%, #f0f8ff 100%);
                            color: #2980b9;
                            font-weight: 600;
                            position: sticky;
                            top: 0;
                            z-index: 10;
                        }
                        #varPanel .variable-table tbody tr:hover {
                            background: #f8fafc;
                        }
                        #varPanel .variable-table tbody tr.selected {
                            background: #e3f2fd !important;
                            border-left: 4px solid #2196f3;
                        }
                        #varPanel .variable-checkbox {
                            margin-right: 8px;
                        }
                        /* å¤šå˜é‡å›¾è¡¨å®¹å™¨æ ·å¼ */
                        .multi-chart-container {
                            display: flex;
                            flex-direction: column;
                            gap: 20px;
                            width: 100%;
                            transition: min-height 0.3s ease-in-out;
                        }
                        
                        .variable-chart {
                            background: #fff;
                            border-radius: 8px;
                            box-shadow: 0 2px 8px rgba(52,152,219,0.06);
                            padding: 20px;
                            border: 1.5px solid #e3eaf2;
                        }
                        
                        .variable-chart-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #e3eaf2;
                        }
                        
                        .variable-chart-title {
                            font-size: 16px;
                            font-weight: 600;
                            color: #2980b9;
                        }
                        
                        .variable-chart-controls {
                            display: flex;
                            gap: 10px;
                        }
                        
                        .variable-chart-controls button {
                            padding: 4px 8px;
                            font-size: 12px;
                            border-radius: 4px;
                        }
                        
                        #varPanel .hex-send-panel {
                            background: #fff;
                            border-radius: 12px;
                            padding: 20px;
                            box-shadow: 0 2px 8px rgba(52,152,219,0.06);
                            border: 1.5px solid #e3eaf2;
                            flex: 1;
                            min-height: 250px;
                            transition: min-height 0.3s ease-in-out;
                        }
                        
                        /* ä¸²å£å‘é€å‘½ä»¤å®¹å™¨çš„ç‰¹æ®Šæ ·å¼ */
                        #varPanel .right-panel .hex-send-panel:first-child {
                            flex-shrink: 0 !important;
                            height: auto !important;
                            min-height: 350px !important;
                            max-height: none !important;
                        }
                        
                        /* ç¡®ä¿HEXæ›²çº¿å›¾å®¹å™¨ä¹Ÿæœ‰è¿‡æ¸¡æ•ˆæœ */
                        .hex-send-panel {
                            transition: min-height 0.3s ease-in-out;
                        }
                        #varPanel .hex-send-controls {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 20px;
                            align-items: flex-start;
                            margin-bottom: 15px;
                            height: 100%;
                            width: 100%;
                        }
                        #varPanel .hex-send-controls input {
                            padding: 8px 12px;
                            border: 1px solid #d0d7de;
                            border-radius: 6px;
                            font-size: 14px;
                            background: #f8fafc;
                        }
                        #varPanel .hex-send-controls button {
                            padding: 8px 16px;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        #varPanel .hex-send-controls .btn-success {
                            background: #2ecc71;
                            color: white;
                        }
                        #varPanel .hex-send-controls .btn-danger {
                            background: #e74c3c;
                            color: white;
                        }
                        #varPanel .hex-send-controls .btn-primary {
                            background: #3498db;
                            color: white;
                        }
                        #varPanel .selected-variables-info {
                            background: #e8f5e8;
                            border: 1px solid #c3e6c3;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 15px;
                        }
                        #varPanel .selected-variables-info h5 {
                            margin: 0 0 10px 0;
                            color: #2d5a2d;
                            font-size: 16px;
                        }
                        #varPanel .selected-variables-list {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 8px;
                            margin-bottom: 10px;
                        }
                        #varPanel .selected-variable-tag {
                            background: #d4edda;
                            color: #155724;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        }
                        #varPanel .selected-variable-tag .remove-btn {
                            background: none;
                            border: none;
                            color: #155724;
                            cursor: pointer;
                            font-size: 14px;
                            padding: 0;
                            margin: 0;
                        }
                        #varPanel .total-size-info {
                            background: #d1ecf1;
                            border: 1px solid #bee5eb;
                            border-radius: 6px;
                            padding: 10px;
                            color: #0c5460;
                            font-weight: 500;
                        }
                    </style>
                    
                    <!-- å˜é‡åˆ†æé¡µé¢æ–°å¸ƒå±€ -->
                    <div class="var-analysis-layout">
                        <!-- å·¦ä¾§é¢æ¿ï¼šæ–‡ä»¶æ“ä½œå’Œå˜é‡åˆ—è¡¨ -->
                        <div class="left-panel">
                            <!-- æ–‡ä»¶æ“ä½œåŒºåŸŸ -->
                            <div class="filter-section">
                                <h4 style="margin:0 0 15px 0;color:#2980b9;font-size:18px;">
                                    <span style="margin-right:8px;">ğŸ“</span>æ–‡ä»¶æ“ä½œ
                                </h4>
                                <div style="margin-bottom:15px;">
                                    <label for="axfFile" class="form-label" style="font-size:15px;margin-bottom:8px;">
                                        <span style="margin-right:6px;">ğŸ“‚</span>é€‰æ‹© .axf æ–‡ä»¶
                                    </label>
                                    <input class="form-control" type="file" id="axfFile" accept=".axf" 
                                           style="padding:12px;border-radius:8px;border:2px solid #e3eaf2;font-size:14px;">
                                    <div style="margin-top:6px;font-size:13px;color:#6c757d;">
                                        <span id="fileStatus">æœªé€‰æ‹©æ–‡ä»¶</span>
                                    </div>
                                </div>
                                <button id="analyzeBtn" class="btn btn-primary" disabled 
                                        style="padding:12px;font-size:15px;font-weight:600;border-radius:8px;width:100%;">
                                    <span style="margin-right:6px;">ğŸ”¬</span>åˆ†ææ–‡ä»¶
                                </button>
                                <div id="fileInfo" class="file-info d-none" style="margin-top:15px;">
                                    <div style="margin-bottom:8px;"><strong>ğŸ“„ æ–‡ä»¶ä¿¡æ¯ï¼š</strong> <span id="fileName">-</span></div>
                                    <div style="margin-bottom:8px;"><strong>ğŸ“Š æ–‡ä»¶å¤§å°ï¼š</strong> <span id="fileSize">-</span></div>
                                    <div style="margin-bottom:8px;"><strong>ğŸ·ï¸ ELF ç±»å‹ï¼š</strong> <span id="elfType">-</span></div>
                                    <div><strong>ğŸ¯ å…¥å£ç‚¹ï¼š</strong> <span id="entryPoint">-</span></div>
                                </div>
                            </div>

                            <!-- å˜é‡ç­›é€‰åŒºåŸŸ -->
                            <div class="filter-section">
                                <h4 style="margin:0 0 15px 0;color:#2980b9;font-size:18px;">
                                    <span style="margin-right:8px;">ğŸ”</span>å˜é‡æœç´¢
                                </h4>
                                <div class="filter-controls">
                                    <input type="text" id="searchFilter" placeholder="æœç´¢å˜é‡å..." style="width:100%;" />
                                </div>
                            </div>

                            <!-- å˜é‡åˆ—è¡¨åŒºåŸŸ -->
                            <div class="variable-table-container">
                                <h4 style="margin:0 0 15px 0;color:#2980b9;font-size:18px;">
                                    <span style="margin-right:8px;">ğŸ“Š</span>å˜é‡åˆ—è¡¨
                                    <span style="margin-left:12px;font-size:13px;font-weight:normal;opacity:0.8;">
                                        (å‹¾é€‰å˜é‡æ·»åŠ åˆ°ä¸²å£å‘é€åŒºï¼Œæœ€å¤š9ä¸ª)
                                    </span>
                                </h4>
                                <div class="progress-container mb-3">
                                    <div id="progressBar" class="progress d-none" style="height:8px;border-radius:6px;background:#f0f0f0;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                                             style="width: 0%;background:linear-gradient(90deg, #3498db, #764ba2);border-radius:6px;"></div>
                                    </div>
                                </div>
                                <div class="table-container" id="varTableContainer" style="max-height:500px;overflow-y:auto;">
                                    <table class="variable-table">
                                        <thead>
                                            <tr>
                                                <th style="width:60px;"><input type="checkbox" id="selectAllVars" /></th>
                                                <th style="width:40%;">å˜é‡å</th>
                                                <th style="width:35%;">åœ°å€</th>
                                                <th style="width:25%;">å¤§å°</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variableTableBody">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted" style="padding:40px 16px;font-size:15px;">
                                                    <div style="margin-bottom:8px;">ğŸ“</div>
                                                    è¯·ä¸Šä¼ .axfæ–‡ä»¶å¹¶ç‚¹å‡»"åˆ†ææ–‡ä»¶"
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- å³ä¾§é¢æ¿ï¼šä¸²å£å‘é€å’Œå®æ—¶å›¾è¡¨ -->
                        <div class="right-panel">
                            <!-- ä¸²å£å‘é€åŒºåŸŸ -->
                            <div class="hex-send-panel" style="min-height: 350px !important; flex-shrink: 0 !important; height: auto !important; max-height: none !important;">
                                <h4 style="margin:0 0 15px 0;color:#2980b9;font-size:18px;">
                                    <span style="margin-right:8px;">ğŸ“¡</span>ä¸²å£å‘é€å‘½ä»¤
                                </h4>
                                
                                <!-- å·²é€‰æ‹©å˜é‡ä¿¡æ¯ -->
                                <div id="selectedVariablesInfo" class="selected-variables-info" style="display:none;">
                                    <h5>å·²é€‰æ‹©çš„å˜é‡</h5>
                                    <div id="selectedVariablesList" class="selected-variables-list"></div>
                                    <div id="totalSizeInfo" class="total-size-info">
                                        æ€»å¤§å°: <span id="selectedTotalSize">0</span> å­—èŠ‚
                                    </div>
                                </div>

                                <!-- ä¸²å£å‘é€æ§åˆ¶ -->
                                <div class="hex-send-controls">
                                    <div style="display:flex;flex-direction:column;gap:8px;align-items:stretch;min-width:120px;">
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span style="color:#495057;font-size:13px;">é‡‡æ ·ç‡ (1-200Hz):</span>
                                            <input id="hexSampleRateInput" type="number" min="1" max="200" value="100" style="width:80px;padding:4px 8px;border-radius:4px;border:1px solid #d0d7de;font-size:12px;">
                                            <span style="color:#495057;font-size:13px;">Hz</span>
                                        </div>
                                        <div style="display:flex;align-items:center;gap:8px;">
                                            <span style="color:#495057;font-size:13px;">æ˜¾ç¤ºèŒƒå›´ (1-30ç§’):</span>
                                            <input id="timeDisplayRangeInput" type="number" min="1" max="30" value="10" style="width:80px;padding:4px 8px;border-radius:4px;border:1px solid #d0d7de;font-size:12px;">
                                            <span style="color:#495057;font-size:13px;">ç§’</span>
                                        </div>
                                        <button id="sendHexCmdBtn" class="btn btn-primary" style="width:100%;padding:10px;">
                                            <span style="margin-right:4px;">ğŸš€</span>å‘é€å‘½ä»¤
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- å®æ—¶HEXæ›²çº¿å›¾ -->
                            <div class="hex-send-panel" style="flex:3;min-height:500px;flex-grow: 1;">
                                <h4 style="margin:0 0 15px 0;color:#2980b9;font-size:18px;">
                                    <span style="margin-right:8px;">ğŸ“ˆ</span>å®æ—¶HEXæ›²çº¿å›¾
                                </h4>
                                <!-- å¤šå˜é‡å›¾è¡¨å®¹å™¨ -->
                                <div id="multiChartContainer" class="multi-chart-container">
                                    <!-- é»˜è®¤å›¾è¡¨ï¼ˆå½“æ²¡æœ‰é€‰æ‹©å˜é‡æ—¶æ˜¾ç¤ºï¼‰ -->
                                    <div id="realtimeChart" style="width:100%;height:600px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(52,152,219,0.06);position:relative;margin-bottom:15px;"></div>
                                </div>
                                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                                    <button id="startChartBtn" class="btn btn-success">å¼€å§‹ç»˜åˆ¶</button>
                                    <button id="clearChartBtn" class="btn btn-secondary">æ¸…ç©ºæ›²çº¿</button>
                                    <button id="stopChartBtn" class="btn btn-danger">ç»ˆæ­¢ç»˜åˆ¶</button>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
            <!-- å³ä¾§å¸¸é©»ç›‘æ§æ  -->
            <div class="monitor-panel">
                <!-- é¡¶éƒ¨è¿æ¥æ§åˆ¶åŒºåŸŸ - æŒ‰é”®å·²ç§»åŠ¨åˆ°å¤´éƒ¨ -->
                <!-- <div class="top-connection-controls">
                    <div class="connection-button-group">
                        <button id="connectBtn" class="btn btn-primary"><i class="fas fa-plug"></i> è¿æ¥ä¸²å£</button>
                        <button id="disconnectBtn" class="btn btn-secondary" disabled><i class="fas fa-times"></i> æ–­å¼€è¿æ¥</button>
                    </div>
                    <div class="utility-button-group">
                        <button id="clearBtn" class="btn btn-warning"><i class="fas fa-trash"></i> æ¸…ç©º</button>
                        <button id="saveLogBtn" class="btn btn-info"><i class="fas fa-save"></i> ä¿å­˜æ—¥å¿—</button>
                    </div>
                </div> -->
                
                <!-- éšè—çš„ä¸²å£é…ç½®ï¼ˆä¿ç•™åŠŸèƒ½ä½†ä¸åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºï¼‰ -->
                <div class="hidden-config" style="display: none;">
                    <div class="config-row">
                        <label for="baudRate">æ³¢ç‰¹ç‡:</label>
                        <select id="baudRate">
                            <option value="9600">9600</option>
                            <option value="115200" selected>115200</option>
                            <option value="1000000">1000000</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                        <input type="number" id="customBaudRate" placeholder="è‡ªå®šä¹‰æ³¢ç‰¹ç‡" style="display:none;">
                    </div>
                    <div class="config-row">
                        <label for="dataBits">æ•°æ®ä½:</label>
                        <select id="dataBits">
                            <option value="7">7</option>
                            <option value="8" selected>8</option>
                        </select>
                        <label for="parity">æ ¡éªŒä½:</label>
                        <select id="parity">
                            <option value="none" selected>æ— </option>
                            <option value="even">å¶</option>
                            <option value="odd">å¥‡</option>
                        </select>
                        <label for="stopBits">åœæ­¢ä½:</label>
                        <select id="stopBits">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="display-options">
                        <label class="checkbox-label"><input type="checkbox" id="hexMode"> HEXæ¨¡å¼</label>
                        <label class="checkbox-label"><input type="checkbox" id="showTimestamp" checked> æ˜¾ç¤ºæ—¶é—´æˆ³</label>
                        <label class="checkbox-label"><input type="checkbox" id="autoScroll" checked> è‡ªåŠ¨æ»šåŠ¨</label>
                        <label class="checkbox-label"><input type="checkbox" id="enableBuffer" checked> å¯ç”¨æ•°æ®ç¼“å†²</label>
                        <label class="checkbox-label"><input type="checkbox" id="virtualTerminalMode" checked> å‘½ä»¤å‘é€æ¨¡å¼</label>
                        <label class="checkbox-label"><input type="checkbox" id="processAnsiSequences" checked> å¤„ç†ANSIåºåˆ—</label>
                        <label class="checkbox-label"><input type="checkbox" id="debugMode"> è°ƒè¯•æ¨¡å¼</label>
                        <label class="checkbox-label"><input type="checkbox" id="integrityCheck" checked> æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</label>
                        <label class="checkbox-label"><input type="checkbox" id="enableDataValidation" checked> å¯ç”¨æ•°æ®éªŒè¯</label>
                        <div class="line-timeout-config">
                            <label for="lineTimeout">åˆ†è¡Œè¶…æ—¶:</label>
                            <input type="number" id="lineTimeout" value="50" min="10" max="1000" step="10" class="timeout-input">
                            <span>ms</span>
                        </div>
                    </div>
                </div>
                <div class="monitor-log" style="margin-top:18px;">
                    <div id="terminal" class="terminal">
                        <div id="terminalOutput" class="terminal-output"></div>
                        <div id="terminalInput" class="terminal-input">
                            <span class="terminal-prompt">$ </span>
                            <input type="text" id="terminalInputField" class="terminal-input-field" placeholder="è¾“å…¥å‘½ä»¤åç‚¹å‡»å‘é€æˆ–æŒ‰Enteré”®å‘é€..." disabled>
                            <button id="terminalSendBtn" class="btn btn-primary" style="margin-left: 8px; padding: 6px 12px; font-size: 12px;" disabled>å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- åµŒå…¥é…ç½®æ–‡ä»¶å†…å®¹ -->
    <script type="text/plain" id="embedded-config">
# MicroLink Web Serial Configuration Parameters
# ä¸²å£é…ç½®
port=COM3
baudrate=115200
databits=8
parity=N
stopbits=1

# RTTé…ç½®
rtt_addr=0x20000000
rtt_size=0x4000
rtt_channel=0

# SystemViewé…ç½®
systemview_addr=0x20000000
systemview_size=0x4000
systemview_channel=1

# FLMé…ç½®
flm_path=STM32/STM32F4xx_1024.FLM.o
base_addr=0x08000000
ram_addr=0x20000000

# ä¸‹è½½é…ç½®
bin_file_path=firmware.bin
bin_addr=0x08000000

# è‡ªå®šä¹‰å‘½ä»¤
custom_commands=RTTView.start(0x20000000,1024,0);SystemView.start(0x20000000,1024,1);load.offline()
    </script>

    <script src="assets/script.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // å³ä¾§åŠŸèƒ½åŒºåˆ‡æ¢é€»è¾‘ï¼ˆå¦‚æœ‰ï¼‰
        const panelSelect = document.getElementById('panelSelect');
        const apiPanel = document.getElementById('apiPanel');
        const flmPanel = document.getElementById('flmPanel');
        const scriptPanel = document.getElementById('scriptPanel');
        const varPanel = document.getElementById('varPanel');
        if (panelSelect && apiPanel && flmPanel && scriptPanel && varPanel) {
            function updatePanelDisplay() {
                apiPanel.style.display = panelSelect.value === 'apiPanel' ? '' : 'none';
                flmPanel.style.display = panelSelect.value === 'flmPanel' ? '' : 'none';
                scriptPanel.style.display = panelSelect.value === 'scriptPanel' ? '' : 'none';
                varPanel.style.display = panelSelect.value === 'varPanel' ? '' : 'none';
            }
            panelSelect.addEventListener('change', updatePanelDisplay);
            updatePanelDisplay();
        }

        // ========== FLM ELFè§£æå™¨æ ¸å¿ƒåŠŸèƒ½ ==========
        const flmFileInput = document.getElementById('flmFile');
        const convertBtn = document.getElementById('convertBtn');
        const log = document.getElementById('log');
        const downloadLink = document.getElementById('downloadLink');
        let flmArrayBuffer = null;
        let flmFileName = '';
        let convertedBlob = null;
        function logMsg(msg) {
            // è¾“å‡ºåˆ°ä¸»ç»ˆç«¯
            appendToTerminalOutput(`<div class='log-prefix-flm'>[FLM] ${msg}</div>`);
            // åŒæ—¶è¾“å‡ºåˆ°æœ¬åœ°logå…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (log) {
                log.textContent += msg + '\n';
                log.scrollTop = log.scrollHeight;
            }
        }
        function parseELFHeader(buffer) {
            const dv = new DataView(buffer);
            if (dv.getUint8(0) !== 0x7f || dv.getUint8(1) !== 0x45 || dv.getUint8(2) !== 0x4c || dv.getUint8(3) !== 0x46) {
                logMsg('ä¸æ˜¯æœ‰æ•ˆçš„ELFæ–‡ä»¶ï¼');
                return null;
            }
            logMsg('ELFé­”æ•°æ ¡éªŒé€šè¿‡');
            const e_shoff = dv.getUint32(32, true);
            const e_shentsize = dv.getUint16(46, true);
            const e_shnum = dv.getUint16(48, true);
            const e_shstrndx = dv.getUint16(50, true);
            logMsg(`èŠ‚å¤´è¡¨åç§»: 0x${e_shoff.toString(16)}, èŠ‚æ•°é‡: ${e_shnum}, èŠ‚å¤´å¤§å°: ${e_shentsize}, èŠ‚åå­—ç¬¦ä¸²è¡¨ç´¢å¼•: ${e_shstrndx}`);
            return { e_shoff, e_shentsize, e_shnum, e_shstrndx };
        }
        function parseSectionHeaders(buffer, elfHeader) {
            const dv = new DataView(buffer);
            const sections = [];
            for (let i = 0; i < elfHeader.e_shnum; i++) {
                const offset = elfHeader.e_shoff + i * elfHeader.e_shentsize;
                sections.push({
                    sh_name: dv.getUint32(offset + 0, true),
                    sh_type: dv.getUint32(offset + 4, true),
                    sh_flags: dv.getUint32(offset + 8, true),
                    sh_addr: dv.getUint32(offset + 12, true),
                    sh_offset: dv.getUint32(offset + 16, true),
                    sh_size: dv.getUint32(offset + 20, true),
                    sh_link: dv.getUint32(offset + 24, true),
                    sh_info: dv.getUint32(offset + 28, true),
                    sh_addralign: dv.getUint32(offset + 32, true),
                    sh_entsize: dv.getUint32(offset + 36, true)
                });
            }
            return sections;
        }
        function getSectionNames(buffer, sections, shstrndx) {
            const dv = new DataView(buffer);
            const shstrtab = sections[shstrndx];
            const names = [];
            for (let i = 0; i < sections.length; i++) {
                const nameOffset = shstrtab.sh_offset + sections[i].sh_name;
                let name = '';
                for (let j = 0; j < 64; j++) {
                    const c = dv.getUint8(nameOffset + j);
                    if (c === 0) break;
                    name += String.fromCharCode(c);
                }
                names.push(name);
            }
            return names;
        }
        function findSectionByName(sectionNames, name) {
            for (let i = 0; i < sectionNames.length; i++) {
                if (sectionNames[i] === name) return i;
            }
            return -1;
        }
        function extractSectionData(buffer, section) {
            return new Uint8Array(buffer, section.sh_offset, section.sh_size);
        }
        function findSymbolAddresses(buffer, sections, sectionNames, symbolNames) {
            const symtabIdx = findSectionByName(sectionNames, '.symtab');
            const strtabIdx = findSectionByName(sectionNames, '.strtab');
            if (symtabIdx === -1 || strtabIdx === -1) {
                logMsg('æœªæ‰¾åˆ° .symtab æˆ– .strtab èŠ‚ï¼');
                return null;
            }
            const symtab = sections[symtabIdx];
            const strtab = sections[strtabIdx];
            const dv = new DataView(buffer);
            const symbolCount = symtab.sh_size / symtab.sh_entsize;
            const addresses = {};
            for (let i = 0; i < symbolCount; i++) {
                const symOffset = symtab.sh_offset + i * symtab.sh_entsize;
                const st_name = dv.getUint32(symOffset + 0, true);
                const st_value = dv.getUint32(symOffset + 4, true);
                let name = '';
                for (let j = 0; j < 64; j++) {
                    const c = dv.getUint8(strtab.sh_offset + st_name + j);
                    if (c === 0) break;
                    name += String.fromCharCode(c);
                }
                if (symbolNames.includes(name)) {
                    addresses[name] = st_value;
                }
            }
            return addresses;
        }
        function extractFlashInfoFromELF(buffer, sections, sectionNames) {
            logMsg('æŸ¥æ‰¾DevDscrèŠ‚:');
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                const sectionName = sectionNames[i];
                logMsg(`  èŠ‚${i}: ${sectionName} (åç§»: 0x${section.sh_offset.toString(16)}, å¤§å°: ${section.sh_size})`);
                if (sectionName === 'DevDscr') {
                    logMsg(`æ‰¾åˆ°DevDscrèŠ‚: åç§» 0x${section.sh_offset.toString(16)}, å¤§å° ${section.sh_size}`);
                    const devDscrData = extractSectionData(buffer, section);
                    const flashInfoSize = 288;
                    if (section.sh_size >= flashInfoSize) {
                        const flashInfo = new ArrayBuffer(flashInfoSize);
                        const flashDv = new DataView(flashInfo);
                        const devDv = new DataView(devDscrData.buffer, devDscrData.byteOffset, devDscrData.byteLength);
                        for (let i = 0; i < flashInfoSize; i++) {
                            flashDv.setUint8(i, devDv.getUint8(i));
                        }
                        const vers = flashDv.getUint16(0, true);
                        let devName = '';
                        for (let i = 0; i < 128; i++) {
                            const c = flashDv.getUint8(2 + i);
                            if (c === 0) break;
                            devName += String.fromCharCode(c);
                        }
                        if (vers !== 0 && devName.length > 0) {
                            logMsg('Flashä¿¡æ¯éªŒè¯é€šè¿‡');
                            logMsg('æˆåŠŸä»DevDscrèŠ‚æå–Flashä¿¡æ¯');
                            return new Uint8Array(flashInfo);
                        } else {
                            logMsg('DevDscrèŠ‚ä¸­çš„æ•°æ®éªŒè¯å¤±è´¥');
                        }
                    } else {
                        logMsg(`DevDscrèŠ‚å¤§å°ä¸è¶³: ${section.sh_size} < ${flashInfoSize}`);
                    }
                }
            }
            logMsg('æœªæ‰¾åˆ°æœ‰æ•ˆçš„Flashä¿¡æ¯æ•°æ®');
            return null;
        }
        function createAlgorithmBlob(buffer, sections, sectionNames) {
            logMsg('åˆ›å»ºç®—æ³•ç¨‹åºblob:');
            logMsg('æŸ¥æ‰¾PrgCodeèŠ‚:');
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                const sectionName = sectionNames[i];
                logMsg(`  èŠ‚${i}: ${sectionName} (åç§»: 0x${section.sh_offset.toString(16)}, å¤§å°: ${section.sh_size})`);
                if (sectionName === 'PrgCode') {
                    logMsg(`æ‰¾åˆ°PrgCodeèŠ‚: åç§» 0x${section.sh_offset.toString(16)}, å¤§å° ${section.sh_size}`);
                    const prgCodeData = extractSectionData(buffer, section);
                    logMsg(`PrgCodeèŠ‚å†…å®¹å·²æå–ï¼Œå¤§å°: ${prgCodeData.length} å­—èŠ‚`);
                    let hexStr = '';
                    for (let j = 0; j < 32 && j < prgCodeData.length; j++) {
                        hexStr += prgCodeData[j].toString(16).padStart(2, '0');
                    }
                    logMsg(`PrgCodeèŠ‚å‰32å­—èŠ‚: ${hexStr}`);
                    return prgCodeData;
                }
            }
            logMsg('æœªæ‰¾åˆ°PrgCodeèŠ‚');
            return null;
        }
        function createFinalBlobWithFlashInfo(programTarget, algorithmBlob, algorithmBlobSize, flashInfo) {
            const ramSize = 8 * 4;
            const finalBlobSize = 64 + ramSize + algorithmBlobSize + flashInfo.length;
            logMsg(`æœ€ç»ˆblobåˆ›å»ºæˆåŠŸï¼Œæ€»å¤§å°: ${finalBlobSize} å­—èŠ‚ (ç»“æ„ä½“: 64 + RAMæ•°ç»„: ${ramSize} + ç®—æ³•: ${algorithmBlobSize} + Flashä¿¡æ¯: ${flashInfo.length})`);
            const finalBlob = new Uint8Array(finalBlobSize);
            let offset = 0;
            finalBlob.set(programTarget, offset); offset += programTarget.length;
            const ramArray = new Uint8Array(32);
            const ramDv = new DataView(ramArray.buffer);
            ramDv.setUint32(0, 0xE00ABE00, true);
            ramDv.setUint32(4, 0x062D780D, true);
            ramDv.setUint32(8, 0x24084068, true);
            ramDv.setUint32(12, 0xD3000040, true);
            ramDv.setUint32(16, 0x1E644058, true);
            ramDv.setUint32(20, 0x1C49D1FA, true);
            ramDv.setUint32(24, 0x2A001E52, true);
            ramDv.setUint32(28, 0x4770D1F2, true);
            finalBlob.set(ramArray, offset); offset += ramArray.length;
            if (algorithmBlob && algorithmBlobSize > 0) {
                finalBlob.set(algorithmBlob, offset); offset += algorithmBlobSize;
            }
            finalBlob.set(flashInfo, offset);
            return finalBlob;
        }
        flmFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                convertBtn.disabled = true;
                logMsg('æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }
            flmFileName = file.name.replace(/\.[^/.]+$/, "");
            const reader = new FileReader();
            reader.onload = function(evt) {
                flmArrayBuffer = evt.target.result;
                convertBtn.disabled = false;
                log.textContent = '';
                logMsg(`å·²åŠ è½½æ–‡ä»¶: ${file.name} (å¤§å°: ${file.size} å­—èŠ‚)`);
            };
            reader.onerror = function() {
                logMsg('æ–‡ä»¶è¯»å–å¤±è´¥');
                convertBtn.disabled = true;
            };
            reader.readAsArrayBuffer(file);
        });
        convertBtn.addEventListener('click', async () => {
            if (!flmArrayBuffer) {
                logMsg('è¯·å…ˆé€‰æ‹©FLMæ–‡ä»¶');
                return;
            }
            logMsg('å¼€å§‹è§£æFLMæ–‡ä»¶...');
            const elfHeader = parseELFHeader(flmArrayBuffer);
            if (!elfHeader) return;
            const sections = parseSectionHeaders(flmArrayBuffer, elfHeader);
            const sectionNames = getSectionNames(flmArrayBuffer, sections, elfHeader.e_shstrndx);
            logMsg('æŸ¥æ‰¾ç®—æ³•å‡½æ•°ç¬¦å·:');
            const symbolNames = ['Init','UnInit','EraseChip','EraseSector','ProgramPage','Read','Verify'];
            const symbolAddrs = findSymbolAddresses(flmArrayBuffer, sections, sectionNames, symbolNames);
            if (!symbolAddrs) return;
            for (const name of symbolNames) {
                const addr = symbolAddrs[name] || 0;
                if (addr !== 0) {
                    logMsg(`  ${name}: 0x${addr.toString(16).padStart(8,'0')}`);
                } else {
                    logMsg(`  ${name}: æœªæ‰¾åˆ°`);
                }
            }
            logMsg('ä»ELFæ–‡ä»¶ä¸­æå–Flashä¿¡æ¯:');
            const flashInfo = extractFlashInfoFromELF(flmArrayBuffer, sections, sectionNames);
            let flash_info;
            if (!flashInfo) {
                logMsg('è­¦å‘Š: æ— æ³•ä»ELFæ–‡ä»¶ä¸­æå–Flashä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                const defaultFlashInfo = new ArrayBuffer(288);
                const dv = new DataView(defaultFlashInfo);
                dv.setUint16(0, 0x0101, true);
                const devName = "STM32F7xx 1024KB Flash (é»˜è®¤)";
                for (let i = 0; i < 128; i++) {
                    dv.setUint8(2 + i, i < devName.length ? devName.charCodeAt(i) : 0);
                }
                dv.setUint16(130, 1, true);
                dv.setUint32(132, 0x08000000, true);
                dv.setUint32(136, 1024 * 1024, true);
                dv.setUint32(140, 256, true);
                dv.setUint32(144, 0, true);
                dv.setUint8(148, 0xFF);
                dv.setUint32(152, 1000, true);
                dv.setUint32(156, 5000, true);
                flash_info = new Uint8Array(defaultFlashInfo);
            } else {
                flash_info = flashInfo;
            }
            const algorithmBlob = createAlgorithmBlob(flmArrayBuffer, sections, sectionNames);
            if (!algorithmBlob) {
                logMsg('ç®—æ³•ç¨‹åºblobåˆ›å»ºå¤±è´¥');
                return;
            }
            const algorithm_blob = algorithmBlob;
            const algorithm_blob_size = algorithmBlob.length;
            logMsg(`ç®—æ³•ç¨‹åºblobåˆ›å»ºæˆåŠŸï¼Œå¤§å°: ${algorithm_blob_size} å­—èŠ‚`);
            logMsg('åˆå§‹åŒ–program_target_tç»“æ„ä½“:');
            const program_target = {};
            program_target.init = (symbolAddrs['Init'] || 0) + 0x20;
            program_target.uninit = (symbolAddrs['UnInit'] || 0) + 0x20;
            program_target.erase_chip = (symbolAddrs['EraseChip'] || 0) + 0x20;
            program_target.erase_sector = (symbolAddrs['EraseSector'] || 0) + 0x20;
            program_target.program_page = (symbolAddrs['ProgramPage'] || 0) + 0x20;
            program_target.read = (symbolAddrs['Read'] !== undefined) ? symbolAddrs['Read'] + 0x20 : 0;
            program_target.verify = (symbolAddrs['Verify'] !== undefined) ? symbolAddrs['Verify'] + 0x20 : 0;
            program_target.breakpoint = 1;
            program_target.static_base = algorithm_blob_size + 0x20 - 4;
            program_target.stack_pointer = algorithm_blob_size + 0x20 + 0x1000;
            program_target.program_buffer = algorithm_blob_size + 0x20 + 0x1800;
            program_target.algo_start = 0;
            program_target.algo_size = algorithm_blob_size + 0x20;
            program_target.algo_blob = 0;
            program_target.program_buffer_size = 0x1000;
            program_target.algo_flags = 0;
            logMsg(`  init: 0x${program_target.init.toString(16).padStart(8,'0')}`);
            logMsg(`  uninit: 0x${program_target.uninit.toString(16).padStart(8,'0')}`);
            logMsg(`  erase_chip: 0x${program_target.erase_chip.toString(16).padStart(8,'0')}`);
            logMsg(`  erase_sector: 0x${program_target.erase_sector.toString(16).padStart(8,'0')}`);
            logMsg(`  program_page: 0x${program_target.program_page.toString(16).padStart(8,'0')}`);
            logMsg(`  read: 0x${program_target.read.toString(16).padStart(8,'0')}`);
            logMsg(`  verify: 0x${program_target.verify.toString(16).padStart(8,'0')}`);
            logMsg(`  sys_call_s.breakpoint: 0x${program_target.breakpoint.toString(16).padStart(8,'0')}`);
            logMsg(`  sys_call_s.static_base: 0x${program_target.static_base.toString(16).padStart(8,'0')}`);
            logMsg(`  sys_call_s.stack_pointer: 0x${program_target.stack_pointer.toString(16).padStart(8,'0')}`);
            logMsg(`  program_buffer: 0x${program_target.program_buffer.toString(16).padStart(8,'0')}`);
            logMsg(`  algo_start: 0x${program_target.algo_start.toString(16).padStart(8,'0')}`);
            logMsg(`  algo_size: 0x${program_target.algo_size.toString(16).padStart(8,'0')}`);
            logMsg(`  program_buffer_size: 0x${program_target.program_buffer_size.toString(16).padStart(8,'0')}`);
            logMsg(`  algo_flags: 0x${program_target.algo_flags.toString(16).padStart(8,'0')}`);
            const programTargetBuffer = new ArrayBuffer(64);
            const ptDv = new DataView(programTargetBuffer);
            let ptOffset = 0;
            ptDv.setUint32(ptOffset, program_target.init, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.uninit, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.erase_chip, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.erase_sector, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.program_page, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.read, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.verify, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.breakpoint, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.static_base, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.stack_pointer, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.program_buffer, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.algo_start, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.algo_size, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.algo_blob, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.program_buffer_size, true); ptOffset += 4;
            ptDv.setUint32(ptOffset, program_target.algo_flags, true); ptOffset += 4;
            const programTarget = new Uint8Array(programTargetBuffer);
            const finalBlob = createFinalBlobWithFlashInfo(programTarget, algorithm_blob, algorithm_blob_size, flash_info);
            const blob = new Blob([finalBlob], {type: 'application/octet-stream'});
            convertedBlob = blob;
            const fileName = `${flmFileName}.FLM.o`;
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = fileName;
            downloadLink.style.display = '';
            downloadLink.textContent = 'ä¸‹è½½ .o æ–‡ä»¶';
            

            
            // è‡ªåŠ¨å¤åˆ¶æ–‡ä»¶ååˆ°å‰ªè´´æ¿
            try {
                await navigator.clipboard.writeText(fileName);
                logMsg(`âœ… æ–‡ä»¶å "${fileName}" å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿`);
            } catch (err) {
                logMsg(`âš ï¸ æ–‡ä»¶åå¤åˆ¶å¤±è´¥: ${err.message}`);
            }
            
            logMsg(`æœ€ç»ˆblobå·²ä¿å­˜åˆ° ${fileName} (åŒ…å«program_target_tç»“æ„ä½“å’ŒFlashä¿¡æ¯)`);
            logMsg('ELFæ–‡ä»¶è§£æå®Œæˆ');
        });
        downloadLink.addEventListener('click', () => {
            setTimeout(() => {
                URL.revokeObjectURL(downloadLink.href);
            }, 1000);
        });
        // ========== FLM ELFè§£æå™¨ YMODEMå‘é€åŠŸèƒ½ ==========
        const flmYmodemSendBtn = document.getElementById('flmYmodemSendBtn');
        const flmYmodemProgress = document.getElementById('flmYmodemProgress');
        // const flmPanel = document.getElementById('flmPanel'); // ç§»é™¤é‡å¤å£°æ˜

        function flmYlog(msg, color) {
            // flmYmodemLog.innerHTML += `<div style='color:${color||'#0f0'}'>${msg}</div>`; // ç§»é™¤æ­¤è¡Œ
            // flmYmodemLog.scrollTop = flmYmodemLog.scrollHeight; // ç§»é™¤æ­¤è¡Œ
            logMsg(`[YMODEM] ${msg}`); // åŒæ—¶è¾“å‡ºåˆ°ä¸»æ—¥å¿—åŒº
        }
        function flmYlogClear() { 
            // flmYmodemLog.innerHTML = ''; // ç§»é™¤æ­¤è¡Œ
        }
        function setFlmYmodemUIBusy(busy) {
            flmYmodemSendBtn.disabled = busy || !convertedBlob || !isSerialConnected();
            flmYmodemProgress.style.display = busy ? '' : 'none';
        }
        function updateFlmYmodemBtn() {
            flmYmodemSendBtn.disabled = !convertedBlob || !isSerialConnected();
        }
        function isSerialConnected() {
            return window.microLinkTerminal && window.microLinkTerminal.isConnected && window.microLinkTerminal.port;
        }
        // ç”Ÿæˆ.oæ–‡ä»¶åä½¿å‘é€æŒ‰é’®å¯ç”¨
        convertBtn.addEventListener('click', function() {
            updateFlmYmodemBtn();
        });
        // å‘é€æŒ‰é’®äº‹ä»¶
        flmYmodemSendBtn.addEventListener('click', async () => {
            if (!convertedBlob) { flmYlog('è¯·å…ˆç”Ÿæˆ.oæ–‡ä»¶', '#ff0'); return; }
            if (!isSerialConnected()) {
                flmYlog('è¯·å…ˆè¿æ¥ä¸²å£', '#f66'); return;
            }
            
            const ymodemMode = 'simple'; // å›ºå®šä¸ºç®€åŒ–æ¨¡å¼
            flmYlogClear();
            setFlmYmodemUIBusy(true);
            flmYmodemProgress.value = 0;
            flmYmodemProgress.max = 100;
            const port = window.microLinkTerminal.port;
            
            try {
                if (window.microLinkTerminal.reader) {
                    try { window.microLinkTerminal.reader.cancel(); } catch(e){}
                    try { window.microLinkTerminal.reader.releaseLock(); } catch(e){}
                    window.microLinkTerminal.reader = null;
                    flmYlog('å·²æš‚åœä¸»ä¸²å£ç›‘å¬ï¼Œå‡†å¤‡YMODEMå‘é€...', '#0ff');
                }
                
                // åªåœ¨æœ€å¼€å§‹å‘é€ä¸€æ¬¡ym.receive()
                const writer0 = port.writable.getWriter();
                await writer0.write(new TextEncoder().encode('ym.receive()\r\n'));
                writer0.releaseLock();
                flmYlog('å·²å‘é€ ym.receive()ï¼Œæ­£åœ¨ç­‰å¾…è®¾å¤‡Cä¿¡å·ï¼ˆæœ€å¤š10ç§’ï¼‰...', '#0ff');
                
                // å¼ºåˆ¶ç›‘å¬ä¸²å£æ»¡10ç§’ï¼Œæ”¶åˆ°Cæˆ–Readyç«‹å³è¿›å…¥ä¸‹ä¸€æ­¥
                let started = false;
                let received = '';
                const startTime = Date.now();
                while (!started && (Date.now() - startTime) < 10000) {
                    let reader = port.readable.getReader();
                    try {
                        const { value, done } = await Promise.race([
                            reader.read(),
                            new Promise(resolve => setTimeout(() => resolve({value: null, done: false}), 200))
                        ]);
                        if (value) {
                            const text = new TextDecoder().decode(value);
                            flmYlog('æ”¶åˆ°å†…å®¹: ' + text, '#888');
                            received += text;
                            if (text.includes('C') || text.includes('Ready')) {
                                started = true;
                                flmYlog('æ”¶åˆ°è®¾å¤‡Cä¿¡å·ï¼Œå‡†å¤‡å‘é€YMODEMæ–‡ä»¶...', '#0f0');
                                break;
                            }
                        }
                    } finally {
                        reader.releaseLock();
                    }
                    await new Promise(r => setTimeout(r, 100));
                }
                if (!started) {
                    flmYlog('10ç§’å†…æœªæ”¶åˆ°è®¾å¤‡Cä¿¡å·ï¼ŒYMODEMå‘é€ä¸­æ­¢', '#f66');
                    return;
                }
                
                // æ ¹æ®é€‰æ‹©çš„æ¨¡å¼ä½¿ç”¨ä¸åŒçš„YMODEMå‡½æ•°
                const arrayBuffer = await convertedBlob.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                const fileName = flmFileName ? (flmFileName + '.FLM.o') : 'firmware.FLM.o';
                
                // ======= ELF tab YMODEMå‘é€æŒ‰é’®äº‹ä»¶ï¼Œå®Œå…¨é•œåƒPYTHON tabé€»è¾‘ =======
                flmYlog('ä½¿ç”¨ç®€åŒ–YMODEMæ¨¡å¼ï¼ˆæä¿å®ˆé…ç½®ï¼‰', '#0ff');
                const simpleOptions = {
                    retryDelay: 1000,       // 1ç§’åŒ…é—´å»¶æ—¶
                    maxRetries: 30,         // 30æ¬¡é‡è¯•
                    packetTimeout: 30000,   // 30ç§’åŒ…è¶…æ—¶
                    restartDelay: 5000      // 5ç§’é‡å¯å»¶æ—¶
                };
                
                await window.ymodemSendFileViaSerialSimple(
                    uint8Array,
                    fileName,
                    120000,
                    progress => { flmYmodemProgress.value = progress; },
                    msg => flmYlog(msg),
                    {
                        ...simpleOptions,
                        buildHeaderPacket: window.buildHeaderPacketFlmYmodem
                    }
                );
                // ======= å±è”½åŸæœ‰ELF tab YMODEMæµç¨‹ =======
                /*
                if (ymodemMode === 'simple') {
                    // ä½¿ç”¨ç®€åŒ–æ¨¡å¼
                    flmYlog('ä½¿ç”¨ç®€åŒ–YMODEMæ¨¡å¼ï¼ˆæä¿å®ˆé…ç½®ï¼‰', '#0ff');
                    const simpleOptions = {
                        retryDelay: 1000,       // 1ç§’åŒ…é—´å»¶æ—¶
                        maxRetries: 30,         // 30æ¬¡é‡è¯•
                        packetTimeout: 30000,   // 30ç§’åŒ…è¶…æ—¶
                        restartDelay: 5000      // 5ç§’é‡å¯å»¶æ—¶
                    };
                    
                    await window.ymodemSendFileViaSerialSimple(
                        uint8Array,
                        fileName,
                        120000,
                        progress => { flmYmodemProgress.value = progress; },
                        msg => flmYlog(msg),
                        {
                            ...simpleOptions,
                            buildHeaderPacket: window.buildHeaderPacketFlmYmodem
                        }
                    );
                } else {
                    // ä½¿ç”¨æ ‡å‡†æ¨¡å¼
                    flmYlog('ä½¿ç”¨æ ‡å‡†YMODEMæ¨¡å¼', '#0ff');
                    const ymodemOptions = {
                        retryDelay: 800,       // å¤§å¹…å¢åŠ åŒ…é—´å»¶æ—¶ï¼Œç»™è®¾å¤‡ç«¯æ›´å¤šå¤„ç†æ—¶é—´
                        maxRetries: 25,        // å¢åŠ é‡è¯•æ¬¡æ•°
                        packetTimeout: 20000,  // å¢åŠ åŒ…è¶…æ—¶æ—¶é—´åˆ°20ç§’
                        restartDelay: 3000     // é‡å¯ä¼ è¾“å‰çš„å»¶æ—¶
                    };
                    
                    flmYlog(`ä½¿ç”¨YMODEMé…ç½®: æ•°æ®åŒ…å¤§å°128å­—èŠ‚(SOH), å»¶æ—¶${ymodemOptions.retryDelay}ms, é‡è¯•${ymodemOptions.maxRetries}æ¬¡, è¶…æ—¶${ymodemOptions.packetTimeout}ms`, '#0ff');
                    
                    await window.ymodemSendFileViaSerial(
                        uint8Array,
                        fileName,
                        120000,
                        progress => { flmYmodemProgress.value = progress; },
                        msg => flmYlog(msg),
                        ymodemOptions
                    );
                }
                
                flmYlog('âœ… æ–‡ä»¶å‘é€å®Œæˆ', '#0f0');
                */
            } catch (e) {
                // é™é»˜å¤±è´¥ï¼Œä¸è¾“å‡ºä»»ä½•æŠ¥é”™æ—¥å¿—
                return;
            } finally {
                flmYlog('congratulations!', '#888');
                setFlmYmodemUIBusy(false);
            }
        });
        // .oæ–‡ä»¶ç”Ÿæˆåè‡ªåŠ¨ä½¿æŒ‰é’®å¯ç”¨
        if (typeof updateFlmYmodemBtn === 'function') updateFlmYmodemBtn();
        // ä¸²å£è¿æ¥çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–°æŒ‰é’®
        // é¡µé¢åˆ‡æ¢åˆ°FLMè§£æå™¨æ—¶ä¹Ÿåˆ·æ–°ä¸€æ¬¡
        if (panelSelect) {
            panelSelect.addEventListener('change', function() {
                if (panelSelect.value === 'flmPanel') {
                    updateFlmYmodemBtn();
                }
            });
        }
        // ========== Pythonè„šæœ¬ç”Ÿæˆå™¨æ ¸å¿ƒåŠŸèƒ½ ==========
        const swdClockSpeedMap = { '10M': '10000000', '5M': '5000000', '2M': '2000000', '1M': '1000000', '500K': '500000', '200K': '200000', '100K': '100000', '50K': '50000', '20K': '20000', '10K': '10000', '5K': '5000' };
        const customFlmInput = document.getElementById('customFlm');
        const address1Input = document.getElementById('address1');
        const address2Input = document.getElementById('address2');

        const swdClockSpeedSelect = document.getElementById('swdClockSpeed');
        const codePreview = document.getElementById('codePreview');
        const dragCodePreview = document.getElementById('dragCodePreview');
        // åˆ é™¤ä¸‹è½½æŒ‰é’®ç›¸å…³ä»£ç 
        // å…¨å±€configå¯¹è±¡ï¼Œä¾›script.jsä½¿ç”¨
        window.config = { 
            flmFile: 'custom_flm.FLM.o', 
            address1: '0X08000000', 
            address2: '0x20000000', 
            swdClockSpeed: '10M',
            files: [
                {
                    fileName: 'boot.bin',
                    address: '0x08000000',
                    algorithm: 'STM32F7x_1024.FLM.o'
                },
                {
                    fileName: 'rtthread.bin',
                    address: '0x08020000', 
                    algorithm: 'STM32F7x_1024.FLM.o'
                },
                {
                    fileName: 'HZK.bin',
                    address: '0x90000000',
                    algorithm: 'STM32F767_W25QXX.FLM.o'
                }
            ]
        };
        const config = window.config;
        function switchScriptTab(scriptType) {
            const tabs = document.querySelectorAll('.script-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            const contents = document.querySelectorAll('.script-content');
            contents.forEach(content => content.classList.remove('active'));
            if (scriptType === 'offline') {
                document.querySelector('.script-tab:first-child').classList.add('active');
                document.getElementById('offlineScript').classList.add('active');
            } else {
                document.querySelector('.script-tab:last-child').classList.add('active');
                document.getElementById('dragScript').classList.add('active');
            }
        }
        function updateCodePreview() {
            const flmFile = config.flmFile;
            const pythonSwdSpeed = swdClockSpeedMap[config.swdClockSpeed] || '10000000';
            
            // ç”Ÿæˆå¤šæ–‡ä»¶çƒ§å½•ä»£ç 
            let offlineCode = `import FLMConfig\nimport PikaStdLib\nimport PikaStdDevice\nimport time\n\ntime = PikaStdDevice.Time()\nbuzzer = PikaStdDevice.GPIO()\nbuzzer.setPin('PA4')\nbuzzer.setMode('out')\n\n# è®¾ç½®SWDä¸‹è½½é€Ÿåº¦\ncmd.set_swd_clock(${pythonSwdSpeed})\n\nReadFlm = FLMConfig.ReadFlm()`;
            
            // æŒ‰ç®—æ³•åˆ†ç»„æ–‡ä»¶
            const algorithmGroups = {};
            config.files.forEach(file => {
                if (file.algorithm && file.fileName && file.address) {
                    if (!algorithmGroups[file.algorithm]) {
                        algorithmGroups[file.algorithm] = [];
                    }
                    algorithmGroups[file.algorithm].push(file);
                }
            });
            
            // ä¸ºæ¯ä¸ªç®—æ³•ç”ŸæˆåŠ è½½å’Œçƒ§å½•ä»£ç 
            Object.keys(algorithmGroups).forEach((algorithm, index) => {
                const files = algorithmGroups[algorithm];
                if (files.length > 0) {
                    // åŠ è½½ç®—æ³•
                    offlineCode += `\n# åŠ è½½ ${algorithm} ä¸‹è½½ç®—æ³•æ–‡ä»¶\nresult = ReadFlm.load("FLM/${algorithm}", ${config.address1}, ${config.address2})\nif result != 0:\n    return`;
                    
                    // çƒ§å½•è¯¥ç®—æ³•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
                    files.forEach(file => {
                        offlineCode += `\n\n# çƒ§å†™ ${file.fileName}\nresult = load.bin("${file.fileName}", ${file.address})\nif result != 0:\n    return`;
                    });
                }
            });
            
            offlineCode += `\n\n# èœ‚é¸£å™¨å“ä¸€å£°ï¼Œè¡¨ç¤ºçƒ§å†™å®Œæˆ\nbuzzer.enable()\nbuzzer.high()\ntime.sleep_ms(500)\nbuzzer.low()\ntime.sleep_ms(500)`;
            
            const dragCode = `import FLMConfig\ncmd.set_swd_clock(${pythonSwdSpeed})\nReadFlm = FLMConfig.ReadFlm()\nres1 = ReadFlm.load(\"FLM/${flmFile}\",${config.address1},${config.address2})`;
            
            if (codePreview) {
                codePreview.textContent = offlineCode;
            }
            if (dragCodePreview) {
                dragCodePreview.textContent = dragCode;
            }
            
            // é«˜äº®æ˜¾ç¤º
            let highlightedCode = offlineCode;
            config.files.forEach(file => {
                if (file.fileName) {
                    highlightedCode = highlightedCode.replace(
                        new RegExp(`"${file.fileName}"`, 'g'), 
                        `<span class="highlight">"${file.fileName}"</span>`
                    );
                }
                if (file.address) {
                    highlightedCode = highlightedCode.replace(
                        new RegExp(file.address.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g'), 
                        `<span class="highlight">${file.address}</span>`
                    );
                }
                if (file.algorithm) {
                    highlightedCode = highlightedCode.replace(
                        new RegExp(`"FLM/${file.algorithm}"`, 'g'), 
                        `<span class="highlight">"FLM/${file.algorithm}"</span>`
                    );
                }
            });
            
            if (codePreview) {
                codePreview.innerHTML = highlightedCode
                    .replace(new RegExp(config.address1.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g'), `<span class="highlight">${config.address1}</span>`)
                    .replace(new RegExp(config.address2.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g'), `<span class="highlight">${config.address2}</span>`)
                    .replace(new RegExp(pythonSwdSpeed.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g'), `<span class="highlight">${pythonSwdSpeed}</span>`);
            }
            
            if (dragCodePreview) {
                dragCodePreview.innerHTML = dragCode.replace(`\"FLM/${flmFile}\"`, `<span class=\"highlight\">\"FLM/${flmFile}\"</span>`).replace(new RegExp(config.address1.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g'), `<span class=\"highlight\">${config.address1}</span>`).replace(new RegExp(config.address2.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g'), `<span class=\"highlight\">${config.address2}</span>`).replace(new RegExp(pythonSwdSpeed.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g'), `<span class=\"highlight\">${pythonSwdSpeed}</span>`);
            }
        }
        // å¤åˆ¶æŒ‰é’®é€»è¾‘
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
        if (customFlmInput) {
            customFlmInput.addEventListener('input', function() { config.flmFile = this.value || 'custom_flm.FLM.o'; updateCodePreview(); });
        }
        if (address1Input) {
            address1Input.addEventListener('input', function() { config.address1 = this.value || '0X08000000'; updateCodePreview(); });
        }
        if (address2Input) {
            address2Input.addEventListener('input', function() { config.address2 = this.value || '0x20000000'; updateCodePreview(); });
        }
        if (swdClockSpeedSelect) {
            swdClockSpeedSelect.addEventListener('change', function() { config.swdClockSpeed = this.value; updateCodePreview(); });
        }
        
        // å¤šæ–‡ä»¶é…ç½®åŠŸèƒ½å·²ç§»è‡³script.jsä¸­å¤„ç†
        

        

        

        

        // åˆ é™¤ä¸‹è½½æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        updateCodePreview();

        // åªå…è®¸å‘é€"ç¦»çº¿ä¸‹è½½è„šæœ¬"å’Œ"æ‹–æ‹½ä¸‹è½½è„šæœ¬"ï¼Œå…¶å®ƒtabç¦ç”¨å‘é€æŒ‰é’®ï¼Œä¸å…è®¸å‘é€æœ¬åœ°.pyæ–‡ä»¶
        // 1. ç§»é™¤æœ¬åœ°.pyæ–‡ä»¶ç›¸å…³UI
        // 2. å‘é€æŒ‰é’®åªåœ¨"ç¦»çº¿ä¸‹è½½è„šæœ¬"æˆ–"æ‹–æ‹½ä¸‹è½½è„šæœ¬"tabä¸‹å¯ç”¨ï¼Œæ–‡ä»¶ååˆ†åˆ«ä¸ºoffline_download.pyå’Œdrag_download.py
        // 3. å…¶å®ƒtabç¦ç”¨å‘é€æŒ‰é’®
        const pyYmodemSendBtn = document.getElementById('pyYmodemSendBtn');
        const pyYmodemProgress = document.getElementById('pyYmodemProgress');
        const pyYmodemLog = document.getElementById('pyYmodemLog');
        function pyYlog(msg, color) {
            appendToTerminalOutput(`<div class='log-prefix-python'>[PYTHON] ${msg}</div>`);
        }
        function pyYlogClear() {
            // ä¸æ¸…ç©ºä¸»ç»ˆç«¯
        }
        function updatePyYmodemSendBtnState() {
            // åªå…è®¸ç¦»çº¿ä¸‹è½½è„šæœ¬å’Œæ‹–æ‹½ä¸‹è½½è„šæœ¬tabå¯ç”¨
            const tab = document.querySelector('.script-tab.active');
            if (tab && tab.textContent.includes('ç¦»çº¿')) {
                pyYmodemSendBtn.disabled = false;
                pyYmodemSendBtn.setAttribute('data-pytype', 'offline');
            } else if (tab && tab.textContent.includes('æ‹–æ‹½')) {
                pyYmodemSendBtn.disabled = false;
                pyYmodemSendBtn.setAttribute('data-pytype', 'drag');
            } else {
                pyYmodemSendBtn.disabled = true;
                pyYmodemSendBtn.removeAttribute('data-pytype');
            }
        }
        // ç›‘å¬tabåˆ‡æ¢
        const scriptTabs = document.querySelectorAll('.script-tab');
        if (scriptTabs.length > 0) {
            scriptTabs.forEach(tab => {
                tab.addEventListener('click', updatePyYmodemSendBtnState);
            });
            updatePyYmodemSendBtnState();
        }
        // ä»¥Python tabä¸ºä¾‹ï¼Œç»Ÿä¸€YMODEMå‘é€æŒ‰é’®äº‹ä»¶
        if (pyYmodemSendBtn) {
            pyYmodemSendBtn.addEventListener('click', async () => {
            if (pyYmodemSendBtn.disabled) return;
            if (!window.microLinkTerminal || !window.microLinkTerminal.isConnected || !window.microLinkTerminal.port) {
                pyYlog('è¯·å…ˆè¿æ¥ä¸²å£', '#f66'); return;
            }
            pyYmodemSendBtn.disabled = true;
            pyYmodemProgress.value = 0;
            pyYmodemProgress.style.display = '';
            pyYlogClear();
            pyYlog('å‡†å¤‡å‘é€...', '#0ff');
            // === åŠ é”ç®¡ç†å’Œç›‘å¬æ§åˆ¶ ===
            let wasConnected = false;
            if (window.microLinkTerminal) {
                if (window.microLinkTerminal.reader) {
                    try { window.microLinkTerminal.reader.cancel(); } catch(e){}
                    try { window.microLinkTerminal.reader.releaseLock(); } catch(e){}
                    window.microLinkTerminal.reader = null;
                }
                wasConnected = window.microLinkTerminal.isConnected;
                window.microLinkTerminal.isConnected = false;
                await new Promise(r => setTimeout(r, 300));
            }
            try {
                let code = '';
                let fileName = '';
                const tabType = pyYmodemSendBtn.getAttribute('data-pytype');
                if (tabType === 'offline') {
                    code = getOfflineCode();
                    fileName = 'Python/offline_download.py';
                } else if (tabType === 'drag') {
                    code = getDragCode();
                    fileName = 'Python/drag_download.py';
                } else {
                    pyYlog('åªå…è®¸å‘é€ç¦»çº¿ä¸‹è½½è„šæœ¬æˆ–æ‹–æ‹½ä¸‹è½½è„šæœ¬', '#f66');
                    return;
                }
                const uint8Array = new TextEncoder().encode(code);
                const port = window.microLinkTerminal && window.microLinkTerminal.port;
                if (!port) throw new Error('ä¸²å£æœªè¿æ¥');
                let ok = await window.sendFileViaYmodem(
                    port,
                    uint8Array,
                    fileName,
                    uint8Array.length,
                    msg => pyYlog(msg)
                );
                if (ok) {
                    pyYlog('âœ… å‘é€å®Œæˆ', '#0f0');
                } else {
                    pyYlog('âŒ å‘é€å¤±è´¥', '#f66');
                }
            } catch (e) {
                pyYlog('âŒ å‘é€å¤±è´¥: ' + e.message, '#f66');
                if (e && e.stack) pyYlog('é”™è¯¯å †æ ˆ: ' + e.stack, '#f66');
            } finally {
                // === æ¢å¤ä¸»ç»ˆç«¯ç›‘å¬ ===
                if (window.microLinkTerminal) {
                    window.microLinkTerminal.isConnected = wasConnected;
                    if (wasConnected && typeof window.microLinkTerminal.startReading === 'function') {
                        window.microLinkTerminal.startReading();
                    }
                }
                pyYmodemSendBtn.disabled = false;
                pyYmodemProgress.style.display = 'none';
            }
        });
        }
        // ä»¥ELF tabä¸ºä¾‹ï¼Œç»Ÿä¸€YMODEMå‘é€æŒ‰é’®äº‹ä»¶
        if (flmYmodemSendBtn) {
            flmYmodemSendBtn.addEventListener('click', async () => {
            if (!convertedBlob) { flmYlog('è¯·å…ˆç”Ÿæˆ.oæ–‡ä»¶', '#ff0'); return; }
            if (!isSerialConnected()) {
                flmYlog('è¯·å…ˆè¿æ¥ä¸²å£', '#f66'); return;
            }
            flmYlogClear();
            setFlmYmodemUIBusy(true);
            flmYmodemProgress.value = 0;
            flmYmodemProgress.max = 100;
            // === åŠ é”ç®¡ç†å’Œç›‘å¬æ§åˆ¶ ===
            let wasConnected = false;
            if (window.microLinkTerminal) {
                if (window.microLinkTerminal.reader) {
                    try { window.microLinkTerminal.reader.cancel(); } catch(e){}
                    try { window.microLinkTerminal.reader.releaseLock(); } catch(e){}
                    window.microLinkTerminal.reader = null;
                }
                wasConnected = window.microLinkTerminal.isConnected;
                window.microLinkTerminal.isConnected = false;
                await new Promise(r => setTimeout(r, 300));
            }
            try {
                const arrayBuffer = await convertedBlob.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                const fileName = flmFileName ? (flmFileName + '.FLM.o') : 'firmware.FLM.o';
                const port = window.microLinkTerminal && window.microLinkTerminal.port;
                if (!port) throw new Error('ä¸²å£æœªè¿æ¥');
                let ok = await window.sendFileViaYmodem(
                    port,
                    uint8Array,
                    fileName,
                    uint8Array.length,
                    msg => flmYlog(msg)
                );
                if (ok) {
                    flmYlog('âœ… æ–‡ä»¶å‘é€å®Œæˆ', '#0f0');
                } else {
                    flmYlog('âŒ å‘é€å¤±è´¥', '#f66');
                }
            } catch (e) {
                // é™é»˜å¤±è´¥ï¼Œä¸è¾“å‡ºä»»ä½•æŠ¥é”™æ—¥å¿—
                return;
            } finally {
                // === æ¢å¤ä¸»ç»ˆç«¯ç›‘å¬ ===
                if (window.microLinkTerminal) {
                    window.microLinkTerminal.isConnected = wasConnected;
                    if (wasConnected && typeof window.microLinkTerminal.startReading === 'function') {
                        window.microLinkTerminal.startReading();
                    }
                }
                flmYlog('YMODEMæµç¨‹å·²ç»“æŸ', '#888');
                setFlmYmodemUIBusy(false);
            }
        });
        }

        // åœ¨tabåˆ‡æ¢åˆ°flmPanelæ—¶è°ƒç”¨updateFlmYmodemBtn
        if (panelSelect) {
            panelSelect.addEventListener('change', function() {
                if (panelSelect.value === 'flmPanel') {
                    updateFlmYmodemBtn();
                }
            });
        }
        // åœ¨convertBtnç‚¹å‡»å’Œä¸²å£è¿æ¥äº‹ä»¶åä¹Ÿè°ƒç”¨updateFlmYmodemBtn
        if (convertBtn) {
            convertBtn.addEventListener('click', function() {
                updateFlmYmodemBtn();
            });
        }
        document.addEventListener('serialConnected', function() {
            updateFlmYmodemBtn();
        });
        document.addEventListener('serialDisconnected', function() {
            updateFlmYmodemBtn();
        });
    });
    </script>
    <!-- deepseekå˜é‡åˆ†æå™¨è„šæœ¬è‡ªåŠ¨é›†æˆï¼ˆå®Œæ•´JSï¼‰ -->
    <script>
    // å†…ç½® ELF è§£æå™¨
    class ELFParser {
        static parse(arrayBuffer) {
            const dataView = new DataView(arrayBuffer);
            // æ£€æŸ¥ ELF é­”æ•°
            if (dataView.getUint32(0) !== 0x7F454C46) {
                throw new Error("ä¸æ˜¯æœ‰æ•ˆçš„ ELF æ–‡ä»¶");
            }
            const is32Bit = dataView.getUint8(4) === 1; // ELFCLASS32
            const isLE = dataView.getUint8(5) === 1; // ELFDATA2LSB
            const header = {
                e_type: dataView.getUint16(16, isLE),
                e_machine: dataView.getUint16(18, isLE),
                e_version: dataView.getUint32(20, isLE),
                e_entry: dataView.getUint32(24, isLE),
                e_phoff: is32Bit ? dataView.getUint32(28, isLE) : Number(dataView.getBigUint64(32, isLE)),
                e_shoff: is32Bit ? dataView.getUint32(32, isLE) : Number(dataView.getBigUint64(40, isLE)),
                e_flags: dataView.getUint32(36, isLE),
                e_ehsize: dataView.getUint16(40, isLE),
                e_phentsize: dataView.getUint16(42, isLE),
                e_phnum: dataView.getUint16(44, isLE),
                e_shentsize: dataView.getUint16(46, isLE),
                e_shnum: dataView.getUint16(48, isLE),
                e_shstrndx: dataView.getUint16(50, isLE)
            };
            // è§£æèŠ‚å¤´
            const sections = [];
            const shoff = Number(header.e_shoff);
            const shentsize = header.e_shentsize;
            const shnum = header.e_shnum;
            for (let i = 0; i < shnum; i++) {
                const offset = shoff + i * shentsize;
                const section = {
                    sh_name: dataView.getUint32(offset, isLE),
                    sh_type: dataView.getUint32(offset + 4, isLE),
                    sh_flags: is32Bit ? dataView.getUint32(offset + 8, isLE) : Number(dataView.getBigUint64(offset + 8, isLE)),
                    sh_addr: is32Bit ? dataView.getUint32(offset + 12, isLE) : Number(dataView.getBigUint64(offset + 16, isLE)),
                    sh_offset: is32Bit ? dataView.getUint32(offset + 16, isLE) : Number(dataView.getBigUint64(offset + 24, isLE)),
                    sh_size: is32Bit ? dataView.getUint32(offset + 20, isLE) : Number(dataView.getBigUint64(offset + 32, isLE)),
                    sh_link: dataView.getUint32(offset + (is32Bit ? 24 : 40), isLE),
                    sh_info: dataView.getUint32(offset + (is32Bit ? 28 : 44), isLE),
                    sh_addralign: is32Bit ? dataView.getUint32(offset + 32, isLE) : Number(dataView.getBigUint64(offset + 48, isLE)),
                    sh_entsize: is32Bit ? dataView.getUint32(offset + 36, isLE) : Number(dataView.getBigUint64(offset + 56, isLE))
                };
                sections.push(section);
            }
            // è·å–èŠ‚åç§°
            const shstrtab = sections[header.e_shstrndx];
            const shstrtabData = new Uint8Array(arrayBuffer, shstrtab.sh_offset, shstrtab.sh_size);
            sections.forEach(section => {
                section.name = this.readNullTerminatedString(shstrtabData, section.sh_name);
            });
            // è§£æç¬¦å·è¡¨
            sections.forEach(section => {
                if (section.sh_type === 2) { // SHT_SYMTAB
                    const symbols = [];
                    const strtab = sections[section.sh_link];
                    const strtabData = new Uint8Array(arrayBuffer, strtab.sh_offset, strtab.sh_size);
                    const count = section.sh_size / section.sh_entsize;
                    for (let i = 0; i < count; i++) {
                        const offset = section.sh_offset + i * section.sh_entsize;
                        const st_name = dataView.getUint32(offset, isLE);
                        const st_value = is32Bit ? dataView.getUint32(offset + 4, isLE) : Number(dataView.getBigUint64(offset + 8, isLE));
                        const st_size = is32Bit ? dataView.getUint32(offset + 8, isLE) : Number(dataView.getBigUint64(offset + 16, isLE));
                        const st_info = dataView.getUint8(offset + (is32Bit ? 12 : 4));
                        const st_shndx = dataView.getUint16(offset + (is32Bit ? 14 : 6), isLE);
                        symbols.push({
                            name: this.readNullTerminatedString(strtabData, st_name),
                            value: st_value,
                            size: st_size,
                            type: st_info & 0x0F,
                            bind: st_info >> 4,
                            sectionIndex: st_shndx
                        });
                    }
                    section.symbols = symbols;
                }
            });
            return {
                header: header,
                sections: sections
            };
        }
        static readNullTerminatedString(data, offset) {
            let str = "";
            let i = offset;
            while (i < data.length && data[i] !== 0) {
                str += String.fromCharCode(data[i]);
                i++;
            }
            return str;
        }
    }
    
    // å†…å­˜åŒºåŸŸå®šä¹‰
    const memoryRegions = [
        { name: "Flash", start: 0x08000000, end: 0x08100000, color: "#4e9a06" },
        { name: "RAM", start: 0x20000000, end: 0x20020000, color: "#3465a4" },
        { name: "Peripherals", start: 0x40000000, end: 0x60000000, color: "#cc0000" }
    ];
    
    // æ®µç±»å‹é¢œè‰²æ˜ å°„
    const sectionColors = {
        '.bss': '#ffd700',
        '.data': '#ff7f50',
        '.rodata': '#ad7fa8',
        '.heap': '#73d216',
        '.stack': '#f57900',
        'default': '#555555'
    };
    
    // å½“å‰åˆ†æçš„å˜é‡åˆ—è¡¨
    let variables = [];
    let elfFile = null;
    let selectedVariables = new Set(); // å­˜å‚¨é€‰ä¸­çš„å˜é‡
    // å°†selectedVariablesæŒ‚è½½åˆ°å…¨å±€ï¼Œä¾›æ•°æ®å¤„ç†å‡½æ•°ä½¿ç”¨
    window.selectedVariables = selectedVariables;
    let filteredVariables = []; // å­˜å‚¨ç­›é€‰åçš„å˜é‡
    
    // DOMå…ƒç´ 
    const fileInput = document.getElementById('axfFile');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const variableTableBody = document.getElementById('variableTableBody');
    const memoryMap = document.getElementById('memoryMap');
    const variableDetail = document.getElementById('variableDetail');

    const fileInfo = document.getElementById('fileInfo');
    const progressBar = document.getElementById('progressBar');
    const searchFilter = document.getElementById('searchFilter');
    const selectAllVars = document.getElementById('selectAllVars');
    const selectedVariablesInfo = document.getElementById('selectedVariablesInfo');
    const selectedVariablesList = document.getElementById('selectedVariablesList');
    const selectedTotalSize = document.getElementById('selectedTotalSize');
    
    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                analyzeBtn.disabled = false;
                fileInfo.classList.add('d-none');
                // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
                const fileStatus = document.getElementById('fileStatus');
                if (fileStatus) {
                    fileStatus.textContent = `å·²é€‰æ‹©: ${this.files[0].name}`;
                    fileStatus.style.color = '#28a745';
                }
            } else {
                analyzeBtn.disabled = true;
                // é‡ç½®æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
                const fileStatus = document.getElementById('fileStatus');
                if (fileStatus) {
                    fileStatus.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                    fileStatus.style.color = '#6c757d';
                }
            }
        });
    }
    
    // ç­›é€‰å™¨äº‹ä»¶ç›‘å¬
            if (searchFilter) {
            searchFilter.addEventListener('input', filterVariables);
        }
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    if (selectAllVars) {
        selectAllVars.addEventListener('change', function() {
            const checkboxes = variableTableBody.querySelectorAll('input[type="checkbox"]:not([id="selectAllVars"])');
            
            if (this.checked) {
                // å…¨é€‰ï¼ˆè€ƒè™‘9ä¸ªå˜é‡é™åˆ¶ï¼‰
                let selectedCount = 0;
                checkboxes.forEach(checkbox => {
                    if (selectedCount < 9) {
                        checkbox.checked = true;
                        selectedVariables.add(checkbox.value);
                        
                        // è®¾ç½®å˜é‡ä¿¡æ¯åˆ°å…¨å±€å¯¹è±¡
                        const variable = variables.find(v => v.name === checkbox.value);
                        if (variable) {
                            if (!window.variableInfo) {
                                window.variableInfo = {};
                            }
                            window.variableInfo[checkbox.value] = {
                                size: variable.size,
                                addr: variable.addr,
                                type: variable.type,
                                section: variable.section
                            };
                            console.log(`[å…¨é€‰] è®¾ç½®å˜é‡ ${checkbox.value} ä¿¡æ¯:`, window.variableInfo[checkbox.value]);
                        }
                        
                        selectedCount++;
                    }
                });
                
                // å¦‚æœå˜é‡æ€»æ•°è¶…è¿‡9ä¸ªï¼Œæ˜¾ç¤ºæç¤º
                if (selectedVariables.size > 9) {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©9ä¸ªå˜é‡ï¼Œå·²è‡ªåŠ¨é™åˆ¶é€‰æ‹©æ•°é‡');
                    // ç§»é™¤è¶…å‡ºé™åˆ¶çš„å˜é‡
                    const selectedArray = Array.from(selectedVariables);
                    for (let i = 9; i < selectedArray.length; i++) {
                        selectedVariables.delete(selectedArray[i]);
                        const checkbox = variableTableBody.querySelector(`input[value="${selectedArray[i]}"]`);
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }
                }
            } else {
                // å–æ¶ˆå…¨é€‰
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    selectedVariables.delete(checkbox.value);
                    
                    // ä»å…¨å±€å¯¹è±¡ä¸­ç§»é™¤å˜é‡ä¿¡æ¯
                    if (window.variableInfo && window.variableInfo[checkbox.value]) {
                        delete window.variableInfo[checkbox.value];
                        console.log(`[å–æ¶ˆå…¨é€‰] ç§»é™¤å˜é‡ ${checkbox.value} ä¿¡æ¯`);
                    }
                });
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateSelectedVariablesDisplay();
            updateHexSendPanel();
        });
    }
    
    // åˆ†ææŒ‰é’®äº‹ä»¶
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function() {
            const file = fileInput.files[0];
            if (!file) return;
            
            // é‡ç½®UI
            variables = [];
            selectedVariables.clear();
            window.variableInfo = {}; // æ¸…ç©ºå˜é‡ä¿¡æ¯
            filteredVariables = [];
            variableTableBody.innerHTML = '<tr><td colspan="6" class="text-center">åˆ†æä¸­...</td></tr>';
            if (memoryMap) memoryMap.innerHTML = '<div class="text-center text-muted mt-5">åˆ†æä¸­...</div>';
            if (variableDetail) variableDetail.innerHTML = 'åˆ†æä¸­...';
    
            if (progressBar) progressBar.classList.remove('d-none');
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progress = progressBar ? progressBar.querySelector('.progress-bar') : null;
            if (progress) progress.style.width = '0%';
            
            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('å¼€å§‹è§£æELFæ–‡ä»¶...');
                    // è§£æELFæ–‡ä»¶
                    const arrayBuffer = e.target.result;
                    elfFile = ELFParser.parse(arrayBuffer);
                    console.log('ELFæ–‡ä»¶è§£ææˆåŠŸ:', elfFile);
                    
                    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                    displayFileInfo(file, elfFile);
                    console.log('æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºå®Œæˆ');
                    
                    // æå–å˜é‡
                    extractVariables(elfFile);
                    console.log('å˜é‡æå–å®Œæˆï¼Œæ‰¾åˆ°å˜é‡æ•°é‡:', variables.length);
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    if (progress) progress.style.width = '100%';
                    setTimeout(() => {
                        if (progressBar) progressBar.classList.add('d-none');
                    }, 500);
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayVariables();
                    drawMemoryMap();
            
                    console.log('å˜é‡åˆ†æå®Œæˆ');
                } catch (error) {
                    console.error('ELFè§£æé”™è¯¯:', error);
                    variableTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">è§£æé”™è¯¯: ${error.message}</td></tr>`;
            
                    if (progressBar) progressBar.classList.add('d-none');
                }
            };
            reader.onprogress = function(e) {
                if (e.lengthComputable && progress) {
                    const percent = (e.loaded / e.total) * 100;
                    progress.style.width = `${percent}%`;
            
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    function displayFileInfo(file, elf) {
        if (fileInfo) {
            fileInfo.classList.remove('d-none');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const elfType = document.getElementById('elfType');
            const entryPoint = document.getElementById('entryPoint');
            
            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = formatFileSize(file.size);
            if (elfType) elfType.textContent = elf.header.e_type;
            if (entryPoint) entryPoint.textContent = `0x${elf.header.e_entry.toString(16).toUpperCase()}`;
        }
    }
    
    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    // æå–å˜é‡
    function extractVariables(elf) {
        variables = [];
        console.log('å¼€å§‹æå–å˜é‡ï¼ŒèŠ‚æ•°é‡:', elf.sections.length);
        
        // éå†æ‰€æœ‰èŠ‚
        const sections = elf.sections;
        for (let i = 0; i < sections.length; i++) {
            const section = sections[i];
            console.log(`èŠ‚ ${i}: åç§°=${section.name}, ç±»å‹=${section.sh_type}, ç¬¦å·æ•°é‡=${section.symbols ? section.symbols.length : 0}`);
            
            // åªå¤„ç†ç¬¦å·è¡¨
            if (section.symbols) {
                // éå†ç¬¦å·è¡¨
                const symbols = section.symbols;
                for (let j = 0; j < symbols.length; j++) {
                    const symbol = symbols[j];
                    // åªå…³æ³¨å˜é‡ï¼ˆç±»å‹ä¸ºSTT_OBJECTï¼‰
                    if (symbol.type === 1) { // STT_OBJECT
                        const addr = symbol.value;
                        const size = symbol.size;
                        const name = symbol.name;
                        const sectionIndex = symbol.sectionIndex;
                        let sectionName = "Undefined";
                        // è·å–æ®µåç§°
                        if (sectionIndex > 0 && sectionIndex < sections.length) {
                            sectionName = sections[sectionIndex].name;
                        }
                        // ç¡®å®šå˜é‡ç±»å‹
                        let varType = "å…¶ä»–";
                        if (sectionName === '.bss') varType = "æœªåˆå§‹åŒ–";
                        else if (sectionName === '.data') varType = "å·²åˆå§‹åŒ–";
                        else if (sectionName === '.rodata') varType = "åªè¯»";
                        else if (sectionName === '.heap') varType = "å †";
                        else if (sectionName === '.stack') varType = "æ ˆ";
                        // åªæ·»åŠ æ®µä¸ºRW_IRAM1å’ŒRW_IRAM2çš„å˜é‡
                        if (sectionName === 'RW_IRAM1' || sectionName === 'RW_IRAM2') {
                            variables.push({
                                name: name,
                                addr: addr,
                                size: size,
                                type: varType,
                                section: sectionName
                            });
                            console.log(`æ‰¾åˆ°RW_IRAM1æ®µå˜é‡: ${name}, åœ°å€: 0x${addr.toString(16)}, å¤§å°: ${size}, ç±»å‹: ${varType}, æ®µ: ${sectionName}`);
                        }
                    }
                }
            }
        }
        
        console.log(`å˜é‡æå–å®Œæˆï¼Œæ€»å…±æ‰¾åˆ° ${variables.length} ä¸ªå˜é‡`);
        
        // æŒ‰åœ°å€æ’åº
        variables.sort((a, b) => a.addr - b.addr);
        // åˆå§‹åŒ–ç­›é€‰åçš„å˜é‡åˆ—è¡¨
        filteredVariables = [...variables];
    }
    
    // ç­›é€‰å˜é‡
    function filterVariables() {
        const searchValue = searchFilter ? searchFilter.value.toLowerCase() : '';
        
        filteredVariables = variables.filter(variable => {
            // åç§°æœç´¢
            if (searchValue && !variable.name.toLowerCase().includes(searchValue)) {
                return false;
            }
            return true;
        });
        
        displayVariables();
        updateSelectedVariablesDisplay();
    }
    
    // æ˜¾ç¤ºå˜é‡è¡¨æ ¼
    function displayVariables() {
        if (filteredVariables.length === 0) {
            variableTableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted" style="padding:40px 16px;font-size:15px;">
                        <div style="margin-bottom:8px;">ğŸ”</div>
                        æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å˜é‡
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        filteredVariables.forEach((variable, index) => {
            const isSelected = selectedVariables.has(variable.name);
            const rowClass = isSelected ? 'selected' : '';
            html += `
                <tr class="${rowClass}" data-variable="${variable.name}">
                    <td>
                        <input type="checkbox" class="variable-checkbox" value="${variable.name}" 
                               ${isSelected ? 'checked' : ''} onchange="toggleVariableSelection(this)">
                    </td>
                    <td>${variable.name}</td>
                    <td>0x${variable.addr.toString(16).toUpperCase()}</td>
                    <td>${variable.size} å­—èŠ‚</td>
                </tr>
            `;
        });
        
        variableTableBody.innerHTML = html;
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateVariableStats();
    }
    
    // åˆ‡æ¢å˜é‡é€‰æ‹©çŠ¶æ€
    function toggleVariableSelection(checkbox) {
        if (checkbox.checked) {
            // æ£€æŸ¥å˜é‡æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š9ä¸ªï¼‰
            if (selectedVariables.size >= 9) {
                alert('æœ€å¤šåªèƒ½é€‰æ‹©9ä¸ªå˜é‡');
                checkbox.checked = false;
                return;
            }
            
            selectedVariables.add(checkbox.value);
            
            // è®¾ç½®å˜é‡ä¿¡æ¯åˆ°å…¨å±€å¯¹è±¡ï¼Œä¾›æ•°æ®å¤„ç†å‡½æ•°ä½¿ç”¨
            const variable = variables.find(v => v.name === checkbox.value);
            if (variable) {
                if (!window.variableInfo) {
                    window.variableInfo = {};
                }
                window.variableInfo[checkbox.value] = {
                    size: variable.size,
                    addr: variable.addr,
                    type: variable.type,
                    section: variable.section
                };
                console.log(`[å˜é‡é€‰æ‹©] è®¾ç½®å˜é‡ ${checkbox.value} ä¿¡æ¯:`, window.variableInfo[checkbox.value]);
            }
            
            // ä¸ºé€‰ä¸­çš„å˜é‡åˆ›å»ºå›¾è¡¨
            if (window.multiChartManager) {
                window.multiChartManager.createChart(checkbox.value);
            }
        } else {
            selectedVariables.delete(checkbox.value);
            
            // ä»å…¨å±€å¯¹è±¡ä¸­ç§»é™¤å˜é‡ä¿¡æ¯
            if (window.variableInfo && window.variableInfo[checkbox.value]) {
                delete window.variableInfo[checkbox.value];
                console.log(`[å˜é‡é€‰æ‹©] ç§»é™¤å˜é‡ ${checkbox.value} ä¿¡æ¯`);
            }
            
            // åˆ é™¤å¯¹åº”çš„å›¾è¡¨
            if (window.multiChartManager) {
                window.multiChartManager.removeChart(checkbox.value);
            }
        }
        
        // æ›´æ–°å…¨é€‰çŠ¶æ€
        updateSelectAllState();
        // æ›´æ–°é€‰ä¸­å˜é‡æ˜¾ç¤º
        updateSelectedVariablesDisplay();
        // æ›´æ–°ä¸²å£å‘é€åŒºåŸŸ
        updateHexSendPanel();
    }
    
    // æ›´æ–°å…¨é€‰çŠ¶æ€
    function updateSelectAllState() {
        if (selectAllVars) {
            const checkboxes = variableTableBody.querySelectorAll('input[type="checkbox"]:not([id="selectAllVars"])');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAllVars.checked = checkedCount === checkboxes.length;
            selectAllVars.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }
    }
    
    // æ›´æ–°å˜é‡ç»Ÿè®¡ä¿¡æ¯
    function updateVariableStats() {
        // ç»Ÿè®¡ä¿¡æ¯å·²ç§»é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ä»¥ç»´æŒä»£ç ç»“æ„
    }
    
    // æ›´æ–°é€‰ä¸­å˜é‡æ˜¾ç¤º
    function updateSelectedVariablesDisplay() {
        if (selectedVariables.size === 0) {
            if (selectedVariablesInfo) selectedVariablesInfo.style.display = 'none';
            // é‡ç½®HEXæ›²çº¿å›¾å®¹å™¨é«˜åº¦
            adjustHexChartContainerHeight(0);
            return;
        }
        
        if (selectedVariablesInfo) selectedVariablesInfo.style.display = 'block';
        let html = '';
        let totalSize = 0;
        
        selectedVariables.forEach(varName => {
            const variable = variables.find(v => v.name === varName);
            if (variable) {
                totalSize += variable.size;
                html += `
                    <div class="selected-variable-tag">
                        ${variable.name} (${variable.size}å­—èŠ‚)
                        <button class="remove-btn" onclick="removeVariableSelection('${varName}')">Ã—</button>
                    </div>
                `;
            }
        });
        
        if (selectedVariablesList) selectedVariablesList.innerHTML = html;
        if (selectedTotalSize) selectedTotalSize.textContent = totalSize;
        
        // åŠ¨æ€è°ƒæ•´HEXæ›²çº¿å›¾å®¹å™¨é«˜åº¦
        adjustHexChartContainerHeight(selectedVariables.size);
    }
    
    // åŠ¨æ€è°ƒæ•´HEXæ›²çº¿å›¾å®¹å™¨é«˜åº¦
    function adjustHexChartContainerHeight(selectedCount) {
        // æ‰¾åˆ°åŒ…å«"å®æ—¶HEXæ›²çº¿å›¾"æ ‡é¢˜çš„å®¹å™¨
        const hexSendPanels = document.querySelectorAll('.hex-send-panel');
        let hexChartPanel = null;
        
        for (let panel of hexSendPanels) {
            const title = panel.querySelector('h4');
            if (title && title.textContent.includes('å®æ—¶HEXæ›²çº¿å›¾')) {
                hexChartPanel = panel;
                break;
            }
        }
        
        const multiChartContainer = document.getElementById('multiChartContainer');
        
        if (!hexChartPanel || !multiChartContainer) return;
        
        // åŸºç¡€é«˜åº¦ï¼šæ ‡é¢˜æ  + æŒ‰é’®æ  + è¾¹è·
        const baseHeight = 120;
        
        // æ¯ä¸ªå˜é‡å›¾è¡¨çš„é«˜åº¦ï¼ˆåŒ…æ‹¬é—´è·ï¼‰
        const chartHeight = 500;
        const chartMargin = 20;
        
        // è®¡ç®—æ€»é«˜åº¦
        let totalHeight;
        if (selectedCount === 0) {
            // æ²¡æœ‰é€‰ä¸­å˜é‡æ—¶ï¼Œä½¿ç”¨é»˜è®¤é«˜åº¦
            totalHeight = 600;
        } else if (selectedCount === 1) {
            // å•ä¸ªå˜é‡æ—¶ï¼Œä½¿ç”¨é€‚ä¸­çš„é«˜åº¦
            totalHeight = baseHeight + chartHeight;
        } else {
            // å¤šä¸ªå˜é‡æ—¶ï¼Œæ ¹æ®æ•°é‡åŠ¨æ€è®¡ç®—
            totalHeight = baseHeight + (selectedCount * (chartHeight + chartMargin));
        }
        
        // è®¾ç½®æœ€å°å’Œæœ€å¤§é«˜åº¦é™åˆ¶
        const minHeight = 800;
        const maxHeight = 3600;
        totalHeight = Math.max(minHeight, Math.min(maxHeight, totalHeight));
        
        // åº”ç”¨é«˜åº¦è°ƒæ•´ - ä¿®æ”¹æ­£ç¡®çš„å®¹å™¨
        hexChartPanel.style.minHeight = totalHeight + 'px';
        multiChartContainer.style.minHeight = (totalHeight - baseHeight) + 'px';
        
        console.log(`[HEXæ›²çº¿å›¾å®¹å™¨è°ƒæ•´] é€‰ä¸­å˜é‡æ•°é‡: ${selectedCount}, å®¹å™¨é«˜åº¦: ${totalHeight}px`);
    }
    
    // ç§»é™¤å˜é‡é€‰æ‹©
    function removeVariableSelection(varName) {
        selectedVariables.delete(varName);
        // åˆ é™¤å¯¹åº”çš„å›¾è¡¨
        if (window.multiChartManager) {
            window.multiChartManager.removeChart(varName);
        }
        // æ›´æ–°è¡¨æ ¼ä¸­çš„å¤é€‰æ¡†
        const checkbox = variableTableBody.querySelector(`input[value="${varName}"]`);
        if (checkbox) {
            checkbox.checked = false;
        }
        // æ›´æ–°æ˜¾ç¤º
        updateSelectAllState();
        updateSelectedVariablesDisplay();
        updateHexSendPanel();
    }
    
    // æ›´æ–°ä¸²å£å‘é€é¢æ¿
    function updateHexSendPanel() {
        // ä¸å†éœ€è¦ç”Ÿæˆåœ°å€è¾“å…¥æ¡†ï¼Œä¿æŒé¢æ¿ç®€æ´
        // ç”¨æˆ·å¯ä»¥é€šè¿‡é‡‡æ ·ç‡è®¾ç½®æ¥æ§åˆ¶å‘é€é¢‘ç‡
    }
    
    // å°†å‡½æ•°æŒ‚è½½åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.displayVariables = displayVariables;
    window.toggleVariableSelection = toggleVariableSelection;
    window.removeVariableSelection = removeVariableSelection;
    
    // æ˜¾ç¤ºå˜é‡è¯¦æƒ…
    window.showVariableDetail = function(index) {
        const varItem = variables[index];
        
        // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºè¯¦æƒ…
        const modalHTML = `
            <div id="variableDetailModal" style="
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 9999; display: flex; 
                align-items: center; justify-content: center;">
                <div style="
                    background: white; border-radius: 12px; padding: 24px; 
                    max-width: 500px; width: 90%; max-height: 80%; overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0; color: #2980b9; font-size: 18px;">
                            <span style="margin-right:8px;">ğŸ”</span>å˜é‡è¯¦ç»†ä¿¡æ¯
                        </h4>
                        <button onclick="closeVariableDetail()" style="
                            background: none; border: none; font-size: 24px; 
                            cursor: pointer; color: #6c757d;">&times;</button>
                    </div>
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 14px; line-height: 1.6;">
                        <div style="margin-bottom: 8px;"><strong>ğŸ“ å˜é‡å:</strong> ${varItem.name}</div>
                        <div style="margin-bottom: 8px;"><strong>ğŸ“ åœ°å€:</strong> 0x${varItem.addr.toString(16).toUpperCase().padStart(8, '0')}</div>
                        <div style="margin-bottom: 8px;"><strong>ğŸ“Š å¤§å°:</strong> ${varItem.size} å­—èŠ‚`;
        
        // æ·»åŠ å¤§å°æè¿°
        if (varItem.size > 1024 * 1024) {
            modalHTML += ` (${(varItem.size/(1024*1024)).toFixed(2)} MB)`;
        } else if (varItem.size > 1024) {
            modalHTML += ` (${(varItem.size/1024).toFixed(2)} KB)`;
        }
        
        modalHTML += `</div>
                        <div style="margin-bottom: 8px;"><strong>ğŸ·ï¸ ç±»å‹:</strong> ${varItem.type}</div>
                        <div style="margin-bottom: 8px;"><strong>ğŸ“‚ æ®µ:</strong> ${varItem.section}</div>`;
        
        // æ·»åŠ å†…å­˜ä½ç½®æè¿°
        if (varItem.addr >= 0x08000000 && varItem.addr < 0x09000000) {
            modalHTML += `<div style="margin-bottom: 8px;"><strong>ğŸ’¾ ä½ç½®:</strong> Flash å­˜å‚¨å™¨</div>`;
        } else if (varItem.addr >= 0x20000000 && varItem.addr < 0x30000000) {
            modalHTML += `<div style="margin-bottom: 8px;"><strong>ğŸ’¾ ä½ç½®:</strong> RAM</div>`;
        } else if (varItem.addr >= 0x40000000 && varItem.addr < 0x60000000) {
            modalHTML += `<div style="margin-bottom: 8px;"><strong>ğŸ’¾ ä½ç½®:</strong> å¤–è®¾å¯„å­˜å™¨åŒºåŸŸ</div>`;
        } else {
            modalHTML += `<div style="margin-bottom: 8px;"><strong>ğŸ’¾ ä½ç½®:</strong> æœªçŸ¥å†…å­˜åŒºåŸŸ</div>`;
        }
        
        modalHTML += `
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="closeVariableDetail()" style="
                            background: #3498db; color: white; border: none; 
                            padding: 10px 20px; border-radius: 6px; cursor: pointer;
                            font-size: 14px;">å…³é—­</button>
                    </div>
                </div>
            </div>
        `;
        
        // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
        const existingModal = document.getElementById('variableDetailModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // æ·»åŠ æ–°æ¨¡æ€æ¡†
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    };
    
    // å…³é—­å˜é‡è¯¦æƒ…æ¨¡æ€æ¡†
    window.closeVariableDetail = function() {
        const modal = document.getElementById('variableDetailModal');
        if (modal) {
            modal.remove();
        }
    };
    
    // ç»˜åˆ¶å†…å­˜æ˜ å°„
    function drawMemoryMap() {
        if (!memoryMap) return;
        
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 400;
        canvas.style.width = '100%';
        canvas.style.height = 'auto';
        
        const ctx = canvas.getContext('2d');
        
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ç»˜åˆ¶å†…å­˜åŒºåŸŸ
        memoryRegions.forEach(region => {
            const y = (region.start - 0x08000000) / (0x60000000 - 0x08000000) * canvas.height;
            const height = (region.end - region.start) / (0x60000000 - 0x08000000) * canvas.height;
            
            ctx.fillStyle = region.color;
            ctx.fillRect(0, y, canvas.width, height);
            
            // æ·»åŠ æ ‡ç­¾
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText(region.name, 10, y + height / 2 + 4);
        });
        
        // ç»˜åˆ¶å˜é‡ä½ç½®
        variables.forEach(variable => {
            const y = (variable.addr - 0x08000000) / (0x60000000 - 0x08000000) * canvas.height;
            const height = Math.max(2, variable.size / (0x60000000 - 0x08000000) * canvas.height);
            
            ctx.fillStyle = sectionColors[variable.section] || sectionColors.default;
            ctx.fillRect(100, y, 20, height);
        });
        
        // æ·»åŠ å›¾ä¾‹
        let legendY = 20;
        Object.entries(sectionColors).forEach(([section, color]) => {
            ctx.fillStyle = color;
            ctx.fillRect(canvas.width - 150, legendY, 15, 15);
            ctx.fillStyle = 'black';
            ctx.font = '10px Arial';
            ctx.fillText(section, canvas.width - 130, legendY + 12);
            legendY += 20;
        });
        
        memoryMap.innerHTML = '';
        memoryMap.appendChild(canvas);
    }
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
        // é‡ç½®UIçŠ¶æ€
        if (variableTableBody) {
            variableTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted" style="padding:40px 16px;font-size:15px;">
                        <div style="margin-bottom:8px;">ğŸ“</div>
                        è¯·ä¸Šä¼ .axfæ–‡ä»¶å¹¶ç‚¹å‡»"åˆ†ææ–‡ä»¶"
                    </td>
                </tr>
            `;
        }
        

        
        // éšè—é€‰ä¸­å˜é‡ä¿¡æ¯
        if (selectedVariablesInfo) {
            selectedVariablesInfo.style.display = 'none';
        }
        
        // åˆå§‹åŒ–HEXæ›²çº¿å›¾å®¹å™¨é«˜åº¦
        adjustHexChartContainerHeight(0);
        
        // åˆå§‹åŒ–é‡‡æ ·ç‡è¾“å…¥æ¡†
        const hexSampleRateInput = document.getElementById('hexSampleRateInput');
        if (hexSampleRateInput) {
            // è®¾ç½®é»˜è®¤é‡‡æ ·ç‡
            const defaultSampleRate = parseInt(hexSampleRateInput.value) || 100;
            if (window.multiChartManager) {
                window.multiChartManager.setSamplingRate(defaultSampleRate);
            }
            
            hexSampleRateInput.addEventListener('input', function() {
                const sampleRate = parseInt(this.value) || 500;
                const period = Math.round(1000 / sampleRate);
                console.log(`é‡‡æ ·ç‡: ${sampleRate} Hz, å¯¹åº”å‘¨æœŸ: ${period} ms`);
                
                // è®¾ç½®å¤šå˜é‡å›¾è¡¨çš„é‡‡æ ·ç‡
                if (window.multiChartManager) {
                    window.multiChartManager.setSamplingRate(sampleRate);
                }
            });
        }
        
        // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤ºèŒƒå›´è¾“å…¥æ¡†
        const timeDisplayRangeInput = document.getElementById('timeDisplayRangeInput');
        if (timeDisplayRangeInput) {
            // è®¾ç½®é»˜è®¤æ—¶é—´æ˜¾ç¤ºèŒƒå›´
            const defaultTimeDisplayRange = parseInt(timeDisplayRangeInput.value) || 10;
            if (window.multiChartManager) {
                window.multiChartManager.setTimeDisplayRange(defaultTimeDisplayRange);
            }
            
            timeDisplayRangeInput.addEventListener('input', function() {
                const timeDisplayRange = parseInt(this.value) || 10;
                console.log(`æ—¶é—´æ˜¾ç¤ºèŒƒå›´: ${timeDisplayRange} ç§’`);
                
                // è®¾ç½®å¤šå˜é‡å›¾è¡¨çš„æ—¶é—´æ˜¾ç¤ºèŒƒå›´
                if (window.multiChartManager) {
                    window.multiChartManager.setTimeDisplayRange(timeDisplayRange);
                }
            });
        }
        
        // åˆå§‹åŒ–ä¸²å£å‘é€åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬å™¨
        const sendHexCmdBtn = document.getElementById('sendHexCmdBtn');
        
        if (sendHexCmdBtn) {
            sendHexCmdBtn.addEventListener('click', function() {
                const hexSampleRateInput = document.getElementById('hexSampleRateInput');
                
                if (!hexSampleRateInput) {
                    alert('é‡‡æ ·ç‡è¾“å…¥æ¡†æœªæ‰¾åˆ°');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„å˜é‡
                if (selectedVariables.size === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦ç›‘æ§çš„å˜é‡');
                    return;
                }
                
                const sampleRate = parseInt(hexSampleRateInput.value) || 100;
                const period = Math.round(1000 / sampleRate); // å°†é‡‡æ ·ç‡è½¬æ¢ä¸ºå‘¨æœŸï¼ˆæ¯«ç§’ï¼‰
                
                // æ ¹æ®é€‰ä¸­çš„å˜é‡åŠ¨æ€ç”Ÿæˆè¯»å–RAMçš„å‘½ä»¤
                let command = 'cmd.read_ram(';
                let first = true;
                
                selectedVariables.forEach(varName => {
                    const variable = variables.find(v => v.name === varName);
                    if (variable) {
                        if (!first) {
                            command += ',';
                        }
                        command += `0x${variable.addr.toString(16).toUpperCase()},${variable.size}`;
                        first = false;
                    }
                });
                
                command += `,${period})`;
                
                // å‘é€å‘½ä»¤åˆ°ä¸²å£
                if (window.microLinkTerminal && window.microLinkTerminal.isConnected) {
                    window.microLinkTerminal.sendCommand(command);
                    console.log('å‘é€å‘½ä»¤:', command);
                    console.log('é‡‡æ ·ç‡:', sampleRate, 'Hz, å‘¨æœŸ:', period, 'ms');
                    console.log('é€‰ä¸­çš„å˜é‡æ•°é‡:', selectedVariables.size);
                } else {
                    alert('è¯·å…ˆè¿æ¥ä¸²å£');
                }
            });
        }
    });
    </script>
    <!-- ECharts - ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ -->
    <script src="assets/echarts.min.js"></script>
    <!-- å¤‡ç”¨CDN -->
    <script>
        if (typeof echarts === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"><\/script>');
        }
    </script>
</body>
</html>
