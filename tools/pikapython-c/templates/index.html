<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢å‘PikaPythonçš„AIé©±åŠ¨Python-Cç¼–è¯‘åŠ é€Ÿå™¨ä¸è‡ªåŠ¨åŒ–éªŒè¯å¹³å°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="sidebar">
        <button id="chat-btn" class="active">èŠå¤©åŠŸèƒ½</button>
        <button id="log-btn">è·å–æ—¥å¿—</button>
        <button id="file-btn">è·å–æ–‡ä»¶</button>
    </div>
    
    <div class="main-content">
        <!-- èŠå¤©éƒ¨åˆ† -->
        <div id="chat-section" class="section active">
            <div class="chat-messages" id="chat-messages"></div>
            <form id="chat-form">
                <div class="chat-input">
                    <textarea id="user-input" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..."></textarea>
                    <button type="submit">å‘é€</button>
                </div>
            </form>
            <div id="loading">å¤„ç†ä¸­...</div>
        </div>
        
        <!-- æ—¥å¿—æ‰«æéƒ¨åˆ† -->
        <div id="log-section" class="section">
            <div class="scan-section">
                <div class="scan-controls">
                    <p>æ—¥å¿—ç›®å½•: {{ LOG_DIR }}</p>
                    <button id="scan-logs-btn">è·å–æ—¥å¿—</button>
                </div>
                <div class="scan-results" id="log-results">
                    <p>è¯·ç‚¹å‡»"è·å–æ—¥å¿—"æŒ‰é’®å¼€å§‹æ‰«æ...</p>
                </div>
            </div>
        </div>
        
        <!-- æ–‡ä»¶æ‰«æéƒ¨åˆ† -->
        <div id="file-section" class="section">
            <div class="scan-section">
                <div class="scan-controls">
                    <p>æ–‡ä»¶ç›®å½•: {{ FILE_DIR }}</p>
                    <button id="refresh-files-btn">åˆ·æ–°æ–‡ä»¶</button>
                </div>
                <div class="scan-results" id="file-results">
                    <p>è¯·ç‚¹å‡»"åˆ·æ–°æ–‡ä»¶"æŒ‰é’®å¼€å§‹æ‰«æ...</p>
                </div>
            </div>
        </div>

    <script>
        // ç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶æ­£ç¡®åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ï¼šåªæ˜¾ç¤ºèŠå¤©éƒ¨åˆ†
            switchSection('chat-section');
            setActiveButton(document.getElementById('chat-btn'));
        });

        // åˆ‡æ¢éƒ¨åˆ†åŠŸèƒ½
        document.getElementById('chat-btn').addEventListener('click', function() {
            switchSection('chat-section');
            setActiveButton(this);
        });
        
        document.getElementById('log-btn').addEventListener('click', function() {
            switchSection('log-section');
            setActiveButton(this);
        });
        
        document.getElementById('file-btn').addEventListener('click', function() {
            switchSection('file-section');
            setActiveButton(this);
        });
        
        function switchSection(sectionId) {
            console.log('åˆ‡æ¢åˆ°éƒ¨åˆ†:', sectionId);
            
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }
        
        function setActiveButton(button) {
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.sidebar button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ä¸ºå½“å‰æŒ‰é’®æ·»åŠ activeç±»
            button.classList.add('active');
        }
        
        // èŠå¤©åŠŸèƒ½
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (!message) return;
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆéœ€è¦è½¬ä¹‰ï¼‰
            addMessage(message, 'user');
            userInput.value = '';
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            // å‘é€è¯·æ±‚åˆ°åç«¯
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.success) {
                    // æ˜¾ç¤ºagentå›å¤ï¼ˆéœ€è¦è½¬ä¹‰ï¼‰
                    addMessage(data.agent_response, 'agent');
                } else {
                    addMessage('é”™è¯¯: ' + data.error, 'agent');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                addMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'agent');
                console.error('Error:', error);
            });
        });

        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // ä½¿ç”¨ innerHTML å¹¶è½¬ä¹‰å†…å®¹ï¼ŒåŒæ—¶ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼
            contentDiv.innerHTML = escapeHtml(content);
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // å…è®¸æŒ‰Enterå‘é€ï¼ŒCtrl+Enteræ¢è¡Œ
        document.getElementById('user-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.ctrlKey) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });
        
        // æ—¥å¿—æ‰«æåŠŸèƒ½
        document.getElementById('scan-logs-btn').addEventListener('click', function() {
            const logResults = document.getElementById('log-results');
            logResults.innerHTML = '<p>å¼€å§‹è·å–æ—¥å¿—æ–‡ä»¶...</p>';
            
            console.log('å¼€å§‹SSEè¿æ¥...');
            
            // ä½¿ç”¨EventSource
            const eventSource = new EventSource('/scan_logs');
            
            eventSource.onopen = function(event) {
                console.log('SSEè¿æ¥å·²å»ºç«‹');
                logResults.innerHTML += '<p style="color: green;">è¿æ¥å·²å»ºç«‹ï¼Œå¼€å§‹æ‰«æ...</p>';
            };
            
            eventSource.onmessage = function(event) {
                console.log('æ”¶åˆ°SSEæ¶ˆæ¯:', event.data);
                
                try {
                    const data = JSON.parse(event.data);
                    
                    // å¿½ç•¥å¿ƒè·³åŒ…
                    if (data.heartbeat) {
                        console.log('æ”¶åˆ°å¿ƒè·³åŒ…');
                        return;
                    }
                    
                    displayLogEntry(data);
                    
                    // å¦‚æœæ˜¯å®Œæˆæ–‡ä»¶ï¼Œå…³é—­è¿æ¥
                    if (data.is_completion) {
                        console.log('æ”¶åˆ°å®Œæˆä¿¡å·ï¼Œå…³é—­è¿æ¥');
                        eventSource.close();
                        logResults.innerHTML += '<p style="color: green;">æ—¥å¿—æ‰«æå®Œæˆ</p>';
                    }
                } catch (e) {
                    console.error('è§£æSSEæ•°æ®é”™è¯¯:', e, 'åŸå§‹æ•°æ®:', event.data);
                    logResults.innerHTML += `<p style="color: red;">æ•°æ®è§£æé”™è¯¯: ${e.message}</p>`;
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('SSEè¿æ¥é”™è¯¯:', event);
                
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('SSEè¿æ¥å·²å…³é—­');
                    logResults.innerHTML += '<p style="color: gray;">è¿æ¥å·²å…³é—­</p>';
                } else {
                    console.log('SSEè¿æ¥é”™è¯¯');
                    logResults.innerHTML += '<p style="color: red;">è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</p>';
                }
                eventSource.close();
            };
            
            // // åœæ­¢æŒ‰é’®
            // const stopButton = document.createElement('button');
            // stopButton.textContent = 'åœæ­¢æ‰«æ';
            // stopButton.onclick = function() {
            //     console.log('æ‰‹åŠ¨åœæ­¢æ‰«æ');
            //     eventSource.close();
            //     logResults.innerHTML += '<p>æ‰«æå·²åœæ­¢</p>';
            //     stopButton.remove();
            // };
            // logResults.appendChild(stopButton);
        });

        // æ˜¾ç¤ºæ—¥å¿—æ¡ç›®çš„å‡½æ•°
        function displayLogEntry(logEntry) {
            const logResults = document.getElementById('log-results');
            
            const isCompletion = logEntry.is_completion || logEntry.filename === 'summary_stats.log';
            const completionClass = isCompletion ? 'completion-file' : '';
            
            const logElement = document.createElement('div');
            logElement.className = `log-file ${completionClass}`;
            logElement.setAttribute('data-log-id', logEntry.n || logEntry.filename);
            
            let content = '';
            if (logEntry.error) {
                content = `é”™è¯¯: ${logEntry.error}`;
            } else if (typeof logEntry.content === 'object') {
                content = JSON.stringify(logEntry.content, null, 2);
            } else {
                content = logEntry.content || '';
            }
            
            const fileName = logEntry.filename || 'æœªçŸ¥æ–‡ä»¶';
            
            logElement.innerHTML = `
                <div class="file-name">${fileName} ${isCompletion ? '(å®Œæˆæ–‡ä»¶)' : ''} [åºå·: ${logEntry.n || 'N/A'}]</div>
                <div class="file-content">${content}</div>
            `;
            
            logResults.appendChild(logElement);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logResults.scrollTop = logResults.scrollHeight;
            
            console.log('å·²æ˜¾ç¤ºæ—¥å¿—æ¡ç›®:', logEntry);
        }
        
        // æ–‡ä»¶æ‰«æåŠŸèƒ½
        document.getElementById('refresh-files-btn').addEventListener('click', function() {
            const fileResults = document.getElementById('file-results');
            fileResults.innerHTML = '<p>æ‰«æä¸­...</p>';
            
            fetch('/refresh_files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFileResults(data.files);
                } else {
                    fileResults.innerHTML = `<p style="color: red;">é”™è¯¯: ${data.error}</p>`;
                }
            })
            .catch(error => {
                fileResults.innerHTML = `<p style="color: red;">ç½‘ç»œé”™è¯¯: ${error}</p>`;
                console.error('Error:', error);
            });
        });

        function displayFileResults(files) {
            const fileResults = document.getElementById('file-results');
            
            if (files.length === 0) {
                fileResults.innerHTML = '<p>æœªæ‰¾åˆ°æ–‡ä»¶</p>';
                return;
            }
            
            let html = '';
            files.forEach(item => {
                const indent = '&nbsp;'.repeat(item.depth * 4);
                const icon = item.type === 'directory' ? 'ğŸ“' : 
                            item.type === 'file' ? 'ğŸ“„' : 'âŒ';
                
                html += `
                    <div class="file-item ${item.type}">
                        <div class="file-name">${indent}${icon} ${item.name}</div>
                        ${item.type === 'file' ? `<div class="file-content">${escapeHtml(item.content)}</div>` : ''}
                    </div>
                `;
            });
            
            fileResults.innerHTML = html;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, "<br>")
                .replace(/ /g, "&nbsp;")
                .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
        }
    </script>
</body>
</html>